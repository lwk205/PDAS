      PROGRAM EPPLER
C...
C... IBM PC/XT/AT VERSION 1.1 BY JOHN G. RONCZ
C...
      CHARACTER*4 MARKEN,MARKE,CPV,ALTX
      CHARACTER*2 NZPZ,NZT,IZT,NNESE,NUFF,KBLT,NAMP
      DIMENSION XF(121),YF(121),BETAF(121),BETA(121)
      DIMENSION MARKEN(24),ALCA(14),CAE(2)
      DIMENSION RE(5),MA(5),MU(5),T(42)
      DIMENSION ALS(5),RER(5),MUR(5)
      DIMENSION TST(5),BANT(5),CW(5,2,14),SU(5,2,14),SA(5,2,14)
      DIMENSION FCI1(2),FCI2(2),FCI3(2),FCI4(2),FCI5(2)
      COMMON P1(121),P(121),XP(121),YP(121),PUFF(22),AGAM(6),X(121),
     1Y(121),DS(122),VF(121),ARG(121),ANI(28),ALFA(29),IZZ,KFU,NQ,NUPRO,
     2JAB,JST,CM,ETA,ABFA,PI,BOGEN,DARG,PURES(13),FUW(60,7),RS(60)
      COMMON XTF,SMA,XFL(10),GAMMA(121,2),AMAT(120,120)
      COMMON /GRZK/CDK,AA(7),BB(7)
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      COMMON/CHARS/NAMP(12),CPV(2),ALTX(4,2),NNESE,NUFF(80)
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      COMMON/TRIT/DLV,SUMP,XTRI(4),NU,ND,XSTPI(4),STHI(4)
      COMMON /LINING/BROKL(12),NLINE(5),NPAR(5),J
      COMMON/SOLLC/ISOLL,JSOLL(5),CSOLL(5),CIST(5),TM(5)
      COMMON/PLOTZ/IPLOT
      COMMON/SONIC/SON(2)
      COMMON/JGR/TFAC
      EQUIVALENCE(XF(1),FUW(1,1)),(YF(1),FUW(2,3)),(BETAF(1),FUW(3,5)),
     *(BETA(1),FUW(4,7)),(CW(1,1,1),P1(1)),(SA(1,1,1),P(20)),
     1 (SU(1,1,1),XP(39))
      DATA MARKEN/'TRA1','TRA2','ALFA','DPIT','ABSZ','STRK','ENDE',
     1'DIAG','RE  ','STRD','FLZW','PLWA','PLW ','MACH','REMO','CDCL',
     2'PAN ','FXPR','FLAP','PUXY','PEN ','SCAL','SYM ','TFAC'/
      DATA ISTIFT,MXZ/1,-1/,KBLT/' '/
      DATA ZAEH,DICHTE/13.6E-6,.12533/
      DATA FCI1/.1,1./,FCI2/1.E5,1000./,FCI3/.001,1./,FCI4/10.,1000./
     *,FCI5/100.,1./
      MPL=0
      TFAC=0.36
      PI = 3.141592654
      BOGEN = 0.0174532925199
      ABFA = 1.0
      AGAM(1)=1.
      AGAM(2)=1.
      AGAM(3)=1.
      AGAM(4)=0.
      AGAM(5)=1.
      ISOLL=0
      NUPA=0
      CALL FINIT
C  REMO - CARD ************
    1 MARD = 0
      IF(NUPA.NE.0)MARD = 1
      MARX=MARD+1
      FCT1=FCI1(MARX)
      FCT2=FCI2(MARX)
      FCT3=FCI3(MARX)
      FCT4=FCI4(MARX)
      FCT5=FCI5(MARX)
    9 MTR=0
    8 DO 10 I=1,5
      NAIT(I)=0
      DO 10 IK=1,5
      AVI(I,IK)=0.
   10 BVI(I,IK)=0.
      IVI=0
   11 IF(MARD.EQ.0)GO TO 7
      READ(ILES,4)MARKE,NUPA,NUPE,NUPI,NUPU,(NUFF(I),I=11,80)
    4 FORMAT(A4,3I1,I3,70A1)
      CALL DLFF(12,PUFF,1,NWD)
      GO TO 17
    7 READ(ILES,2)MARKE,NUPA,NUPE,NUPI,NUPU,(PUFF(I),I=1,14)
    2 FORMAT(A4,3I1,I3,14F5.2)
      NWD=14
   17 IF(NWD.GT.22)GO TO 14
      IF(NWD.EQ.22)GO TO 6
      NWP=NWD+1
      DO 5 I=NWP,22
    5 PUFF(I)=0.
    6 DO 12 I=1,24
      IF (MARKE.EQ.MARKEN(I)) GO TO 13
   12 CONTINUE
   14 WRITE(IDRU,3) MARKE
    3 FORMAT (11H INCORRECT ,A4,5H CARD)
      IF(NWD.GT.22)GO TO 150
      GO TO 11
C   TRA1TRA2ALFADPITABSZSTRKENDEDIAGRE  STRDFLZWPLWAPLW MACHREMOCDCL
C   PAN FXPRFLAPPUXY
   13 GO TO(15,22,333,210,142,90,150,104,30,112,30,71,60,16,1,160,
     *170,180,190,106,400,500,600,700),I
C   MACH-CARD
   16 FMACH=FCT1*PUFF(1)
      BEMACH=SQRT(1.-FMACH*FMACH)
      IF(MSPLI.EQ.0)CALL SPLITZ(X,Y,NQ,BETA)
      IF(FMACH.EQ.0.)GO TO 173
      VSON=SQRT((5.+FMACH*FMACH)/6.)/FMACH
      VSQ=VSON*VSON
      CALL CPCOR(VSQ,VSQ)
      SON(2)=1.-VSQ
      SON(1)=VSON
      GO TO 173
C   TRA1 CARD
   15 NUPRO=NUPU+1000*NUPI
      IF(MTR.EQ.0)JST=0
      I=0
   18 I=I+1
      ANRI=RUND(PUFF(I)*ABFA,1000.)
      IF(ANRI.NE.0.)GO TO 20
      IF(JST.NE.0)GO TO 21
      JST=MTR+1
   20 MTR=MTR+1
      ANI(MTR)=ANRI
      I=I+1
      ALFA(MTR)=PUFF(I)
      IF(I.NE.NWD)GO TO 18
   21 JAB=MTR
      GOTO 11
C   TRA2 CARD
   22 DO 23 I=1,13
   23 PURES(I)=RUND(PUFF(I),1000.)
      MSPLI=0
      ITP=0
      IZZ=INT(PUFF(14))
      CALL TRAPRO
      IF (NUPA.NE.0) READ (ILES,24) NAMP
   24 FORMAT (12A1)
      XDA=0.
      YDA=0.
      DEFLG=0.
      FLCH=0.
      GO TO 9
C   RE   CARD
   25 IF(NUPU.NE.0)GO TO 32
      IF(PUFF(2).EQ.0.)GO TO 28
      DO 27 J=1,5
      RERX=FCT2* PUFF(2*J)
      IF(RERX.EQ.0.)GO TO 26
      RE(J)=RERX
      IPU = INT(FCT1*PUFF(2*J-1)+.1)
      MA(J) = IPU/10
      MU(J) = IPU - 10*MA(J)
   27 JR  = J
   26 DO 29 J=1,4
      XSTPI(J)=0.
      STHI(J)=0.
   29 XTRI(J)=PUFF(J+10)/FCT5
   28 CALL GRP(NAL,RE,MU,JR,ISTIFT)
      MSPLI=0
      JP=JR
      GOTO 11
   32 ISOLL=0
   33 IPU=2*ISOLL+1
      PZW=PUFF(IPU)
      IF(PZW.EQ.0.)GO TO 11
      ISOLL=ISOLL+1
      JSOLL(ISOLL)=INT(PZW)
      CIM=PUFF(IPU+1)
      IF(CIM.LT.0.)CIM=.01*CIM
      CSOLL(ISOLL)=CIM
      GO TO 33
C   FLZW CARD
   30 IF(NUPA.EQ.0) GO TO 31
      AGAM(3)=FLOAT(NUPE)
      AGAM(4)=FLOAT(NUPI)
      IF (NUPI.GT.0) IPLOT=5
   31 IF(I.EQ.9) GO TO 25
      IF(PUFF(2).EQ.0.) GO TO 36
      GDF = PUFF(1)
      VMAX = PUFF(2)
      IF(PUFF(3).NE.0.) DICHTE = FCT1*PUFF(3)/9.806
      IF(PUFF(4).NE.0.)ZAEH = PUFF(4)*1.E-6
      IF(PUFF(5).EQ.0.) GO TO 50
      D = 0.
      DO 34 J = 1,5
      JZ = 2*J + 3
      IF(PUFF(JZ).EQ.0.) GO TO 36
      TM(J)=PUFF(JZ)
      ALX=PUFF(JZ+1)
      MUX=INT(ALX/100.)
      ALS(J)=ALX-100.*FLOAT(MUX)
      MUR(J) = NUPU
      IF(MUX.NE.0)MUR(J)=MUX
   34 JT = J
   36 IZT=NZPZ(2,6*NAL+2)
      JP=JT
      WRITE(IDRU,37)IZT,NAMP,(ALTX(J,ITIT2),J=1,4)
   37 FORMAT (A1,36HAIRCRAFT-ORIENTED SUMMARY   AIRFOIL ,12A1,3X,
     *31HANGLE OF ATTACK RELATIVE TO THE,4A4)
      IVMAX=INT(VMAX*3.6)+1
      IZT=NZPZ(2,0)
      WRITE(IDRU,38)IZT,GDF,IVMAX,DICHTE,ZAEH
   38 FORMAT (A1,6H W/S =,F6.2,8H KG/SQ.M,3X,7HV MAX =,I4,5H KM/H,3X,
     *5HRHO =,F5.3,13H KG*S E2/M E4,3X,4HNU =,F10.8,7H SQ.M/S)
      IZT=NZPZ(2,0)
      WRITE(IDRU,40)IZT,(KBLT,TM(J),ALS(J),J=1,JT)
   40 FORMAT (A1,5X,5(A1,4X,3HC =,F5.2,8H THETA =,F5.2))
   41 V1 = SQRT(2.*GDF/DICHTE)
      DO 48 I=1,NAL
      IVS = -I
      DO 46 J = 1,JT
      IF(ALV(I)-ALS(J))42,44,42
   42 VALF = V1/SQRT(.11*X(1)*ABS(ALV(I)-ALS(J)))
      IF(VALF - VMAX)46,46,44
   44 VALF = VMAX
   46 RER(J) = VALF*TM(J)/ZAEH
   48 CALL GRP(IVS,RER,MUR,JT,ISTIFT)
      MSPLI=0
   49 IF(D) 72,50,72
   50 GO TO 11
C   PLW  CARD
   60 IF(PUFF(1))62,68,62
   62 DST = PUFF(1)*FCT1
      GST = PUFF(2)
      DGF = PUFF(3)
      CWSF = PUFF(4)*FCT3
      DO 66 J = 1,5
      JZ = 2*J+3
      IF(PUFF(JZ))64,68,64
   64 TST(J) = PUFF(JZ)
      BANT(J) = PUFF(JZ+1)
      MUR(J) = NUPU
   66 JT = J
   68 BF = 0.
      FST = 0.
      NF = 0
      CALL DIA(X,Y,NQ,D)
      IF(DST.LT.0.) DST = D
      DO 70 J = 1,JT
      TM(J) = TST(J)*DST/D
      ALS(J) = 0.
      BF = BF + BANT(J)
   70 FST = FST + BANT(J)*TST(J)
      FF = FST*DST/D
      GEW = GST + (FF-FST)*DGF
      GDF = GEW/FF
      GO TO 36
C   PLWA CARD
   71 NAN = NUPU
      CWSFU=CWSF
      FAU = FF
      GAU = GEW
      NF=1
  972 FF = FF+PUFF(1)
      GEW = GEW+PUFF(2)
      CWSF=CWSF+FCT3*PUFF(3)
      V1 = SQRT(2.*GEW/(DICHTE*FF))
   72 IZT=NZPZ(3,NAL+10)
      WRITE(IDRU,74)IZT,NAMP
   74 FORMAT (A1,25HAIRCRAFT POLAR   AIRFOIL ,12A1)
      CWS = CWSF/FF
      IZT=NZPZ(2,0)
      WRITE(IDRU,76)IZT
   76 FORMAT (A1,39H  B(M)  S(SQ.M) S*(SQ.M) W(KG)   W*(KG),
     *3X,3HT/C,3X,6H(T/C)*,2X,8HAP(SQ.M),2X,3HCDP)
      IZT=NZPZ(1,0)
      WRITE(IDRU,78)IZT,BF,FF,FST,GEW,GST,D,DST,CWSF,CWS
   78 FORMAT (A1,F6.2,2F8.2,2F8.0,4F8.4)
      IZT=NZPZ(2,0)
      WRITE(IDRU,80)IZT
   80 FORMAT (A1,54H ALPHA     CL     CDP     CDT   V(KM/H)  VS(M/S)   L
     */D)
      DO 84 I = 1,NAL
      CA = 0.
      CWP = 0.
      DO 82 J = 1,JT
      BATF=BANT(J)*TST(J)/FST
      CALL VISC(I,J,CANT,CWNT,CMDU,ALRC)
      CA=CA+CANT*BATF
   82 CWP=CWP+CWNT*BATF
      CWGES = CWP + CWS + 1.03*CA*CA*FF/(PI*BF*BF)
      IF(ABS(CA).LT..01)CA=.01
      VKMH = 3.6*V1/SQRT(ABS(CA))
      VS = VKMH*CWGES/(3.6*ABS(CA))
      GLTZ = CA/CWGES
      IZT=NZPZ(1,0)
   84 WRITE(IDRU,86) IZT,ALV(I),CA,CWP,CWGES,VKMH,VS,GLTZ
   86 FORMAT (A1,F6.2,F8.3,2F8.4,F8.1,F9.3,F8.2)
      IF(NF.EQ.0) GO TO 50
      NF=NF+1
      IF (NF.LE.NAN) GO TO 972
   88 CONTINUE
      CWSF = CWSFU
      FF=FAU
      GEW = GAU
      GO TO 50
C   STRK CARD
   90 IPLOT=3
      IF(NUPU)94,100,92
   92 NT = 0
   94 DO 98 J = 1,14
      IF(PUFF(J)) 96,100,96
   96 NT = NT + 1
   98 T(NT) = PUFF(J)*10.
      IF(IABS(NUPU).GT.14) GO TO 11
  100 CALL STRDR(T,NT)
      IF(NUPI.NE.0) GO TO 11
      DO 102 I = 1,NT
  102 CALL STRAAK(T(I),RUA,YBL,MXZ,ISTIFT,X,Y,BETA,NQ)
      GO TO 11
C   DIAG CARD
  104 IPLOT=1
      CALL DIAGR(ISTIFT,NUPU,NUPI,1,NAL,X,Y,BETA,NQ)
      GO TO 11
C   PUXY CARD
  106 CALL PUDECK
      GO TO 11
C   STRD CARD
  112 IF(NUPU.NE.0) MXZ = NUPU
      YBL=FCT5*PUFF(1)
      RUA=FCT5*PUFF(2)
      GO TO 11
C   ABSZ CARD
  142 IF(NUPA.NE.0) AGAM(2)=FLOAT(NUPE)
      IF(PUFF(2).NE.0.) ABFA=PUFF(2)
      GO TO 11
C   ENDE CARD
  150 IF(MGC.NE.0) CALL GCLOSE
      IF(MPL.NE.0)CALL FINISH
      STOP
C   CDCL CARD
  160 IPLOT=2
      IF(NUPA.EQ.0)GO TO 166
      BL1=PUFF(1)+.005
      BL2=PUFF(2)+.005
      DO 162 K=1,5
      NLINE(K)=INT(BL1*(10.**(K-3)))-10*INT(BL1*(10.**(K-4)))
  162 NPAR(K) =INT(BL2*(10.**(K-3)))-10*INT(BL2*(10.**(K-4)))
      DO 164 K=1,12
  164 BROKL(K)=PUFF(K+2)
      GO TO 11
  166 CALL CDCL(NUPU,JP,ISTIFT)
      GO TO 11
C   FXPR CARD
  180 ITP=NUPU
      FMACH=0.
      CALL FIXLES
      MSPLI=0
C   PAN  CARD
  170 IF(MSPLI.EQ.0)CALL SPLITZ(X,Y,NQ,BETA)
      IF(NUPA.NE.0) AGAM(5)=FLOAT(NUPE)
      IF(NUPA.EQ.9) GO TO 11
      DO 172 I=1,22
      IF(PUFF(I).EQ.0.)GO TO 172
      MEIG=INT(PUFF(I))
      MEI=MEIG/10
      KEI =MEIG-10*MEI
      XSTX=ABS(PUFF(I)-FLOAT(MEIG))
      CALL PADD(X,Y,BETA,NQ,MEI,KEI,XSTX)
  172 CONTINUE
      XDA=0.
      YDA=0.
      FLCH=0.
      DEFLG=0.
  173 DO 174 I=1,NQ
      XF(I)=X(I)
      YF(I)=Y(I)
  174 BETAF(I)=BETA(I)
      DLTR=DLT
      DLTUR=DLTU
      NQRS=NQ
  176 NKR=NQ-1
      ITIC=0
      CALL PANEL(X,Y,BETA,ITIC,NKR,AMAT,GAMMA,CAE)
      DARG = ALN
      GO TO 8
C   FLAP CARD
  190 IF(NUPI.EQ.0)GO TO 184
      IF(NUPI.NE.1)GO TO 185
      CHORD=XF(1)
      XDA=CHORD*PUFF(1)/FCT5
      YDA=CHORD*PUFF(2)/FCT5
  185 CALL MOMENT(X,Y,0,NUPI,0)
      GO TO 11
  184 IF(ITP.EQ.2)GO TO 192
      CALL SPLITZ (X,Y,NQ,BETA)
      DO 194 I=1,NQ
      XF(I)=X(I)
      YF(I)=Y(I)
  194 BETAF(I)=BETA(I)
      DLTR=DLT
      DLTUR=DLTU
      NQRS=NQ
  192 IF(NUPA.EQ.0)GO TO 189
      DO 187 I=1,NQRS
      X(I)=XF(I)
      Y(I)=YF(I)
  187 BETA(I)=BETAF(I)
      DLT=DLTR
      DLTU=DLTUR
      NQ=NQRS
      NERZ=3
      DO 188 I=1,13,2
      NERR=INT(PUFF(I))
      IF(NERR.LE.0)GO TO 188
      SNERR=SIN(BETA(NERR))
      IF( ABS(SNERR).LT..00001)GO TO 188
      EDEL=FCT1*PUFF(I+1)
      Y(NERR)=Y(NERR)-EDEL*.01/SNERR
      NZT=NZPZ(NERZ,0)
      NERZ=1
      WRITE(IDRU,196)NZT,NERR,X(NERR),EDEL
  196 FORMAT(A1,24HSURFACE CHANGED AT POINT,I4,3H X=,F7.5,3H BY,F6.3,
     * 2H %)
  188 CONTINUE
      CALL SPLITZ(X,Y,NQ,BETA)
      GO TO 202
  189 IF(NUPU.EQ.0)GO TO 200
      IF(NUPU.NE.1)GO TO 191
      NZT=NZPZ(2,20)
      WRITE(IDRU,193)NZT,NUPRO
  193 FORMAT(A1,26HVARIABLE GEOMETRY AIRFOIL ,I4)
  191 CALL VGEO(XF,YF,NQRS,PUFF,NUPU,X,Y,BETA,NQ)
  195 XCH=X(1)
      YCH=Y(1)
      IF(NUPU.LT.4)GO TO 11
      IF(NUPU.EQ.4)GO TO 198
      RXYQ=XCH*XCH+YCH*YCH
      AXYT=XCH/RXYQ
      BXYT=YCH/RXYQ
      DO 197 I=1,NQ
      XZXY=AXYT*X(I)+BXYT*Y(I)
      Y(I)=AXYT*Y(I)-BXYT*X(I)
  197 X(I)=XZXY
      CALL SPLITZ(X,Y,NQ,XP)
      NUPU=4
      GO TO 195
  198 NHKW=NQ/20
      DLT=(Y(NHKW)-YCH)/(BOGEN*(XCH-X(NHKW)))
      NHKW=NQ-NHKW+1
      DLTU=(YCH-Y(NHKW))/(BOGEN*(XCH-X(NHKW)))
      GO TO 202
  200 CHORD = XF(1)
      FLCH=PUFF(1)*100./FCT5
      XDA=(1.-.01*FLCH)*CHORD
      YDA=PUFF(2)*CHORD/FCT5
      ARCL=PUFF(3)*CHORD/FCT5
      DEFLG=PUFF(4)
      DLT=DLTR+DEFLG
      DLTU=DLTUR-DEFLG
      DEFL=DEFLG*BOGEN
      ARCLU=PUFF(5)*CHORD/FCT5
      MSPLI=1
      CALL FLAP(XF,YF,BETAF,NQRS,XDA,YDA,ARCL,ARCLU,DEFL,X,Y,BETA,NQ)
  202 IF(NUPE-9)176,173,176
C   DPIT CARD
  210 IPLOT=4
      DO 212 K=1,5
  212 NAIT(K)=INT(PUFF(K)*FCT5+.1)
      GO TO 11
C   ALFA CARD
  333 IF(NUPA.EQ.0) GO TO 330
      MOMAG=NUPA
      AGAM(1)=FLOAT(NUPE)
      IF(NUPA.EQ.1) AGAM(5)=FLOAT(NUPE+1)
  330 IF(NUPU.EQ.0) GO TO 335
      DO 331 I=1,14
  331 ALCA(I)=PUFF(I)
  328 ITIT1=NUPI/2+1
      ITIT2=NUPI-2*ITIT1+3
      DARF=0.
      IF(ITIT2.NE.1)DARF=1.
      NAL=IABS(NUPU)
      IF(NAL.GT.14)NAL=4
  335 DO 334 I=1,NAL
      PA=ALCA(I)
      IF(PA.LE.-99.) PA=RS(30+I)
      IF(PA.GT.-99.) PA=PA+DARF*DARG
  334 ALV(I)=PA
      IVI=0
      CALL MOMENT (X,Y,NQ,1,NAL)
      IF(AGAM(1).EQ.0.)GO TO 11
      NZF=NQ+3
      IF(ITP.EQ.2.AND.AGAM(5).EQ.1.)NZF=25
      CALL DIA(X,Y,NQ,THK)
      THKP=100.*THK
      DO341 N=1,NQ
      ND=N-1
      XDR=X(N)
      YDR=Y(N)
      DO 340M=1,NAL
      VZ=ABS(VPR(N,M))
      IF(ITIT1.NE.2)GO TO 340
      VQ=VZ*VZ
      IF(FMACH.NE.0.)CALL CPCOR(VQ,VQ)
      VZ=1.-VQ
  340 P1(M)=VZ
      NZT=NZPZ(1,NZF)
      IF(NZT.NE.NNESE.AND.N.NE.1)GO TO 341
      NZF=0
      DO  339 M=1,NAL
  339 P(M)=ALV(M)-DARF*DARG
      IF(ITP.EQ.2)GO TO 332
      WRITE(IDRU,337)NZT,NUPRO,THKP,(P(M),M=1,NAL)
  337 FORMAT(A1,8HAIRFOIL ,I4,F8.2,1H%,F11.2,13F7.2)
      GO TO 346
  332 WRITE(IDRU,336)NZT,NAMP,THKP,FLCH,DEFLG,FMACH,(P(M),M=1,NAL)
  336 FORMAT(A1,8HAIRFOIL ,12A1,F6.2,12H% THICKNESS,,F9.2,6H% FLAP,F7.2,
     *'DEGREES DEFLECTION'/6H MACH=,F5.3,15X,14F7.2)
      NZT=NZPZ(1,0)
      IF(FMACH.NE.0.)WRITE(IDRU,348)CPV(ITIT1),SON(ITIT1)
  348 FORMAT(1H+,11X,A4,4HSON=,F6.3)
  346 NZT=NZPZ(1,0)
      WRITE(IDRU,338)NZT,CPV(ITIT1),(ALTX(M,ITIT2),M=1,4)
  338 FORMAT(A1,'  N',7X,'X',10X,'Y',3X,A4,'-DISTRIBUTIONS FOR THE ABOV'
     $ ,'E ANGLES OF ATTACK RELATIVE TO THE',4A4)
      NZT=NZPZ(1,0)
  341 WRITE(IDRU,342)ND,XDR,YDR,(P1(M),M=1,NAL)
  342 FORMAT(1X,I3,2F11.7,14F7.3)
      IF(ITP.EQ.2)GO TO 11
      NZT=NZPZ(1,0)
      WRITE(IDRU,344)NZT,DARG,CM,ETA
  344 FORMAT (A1,8HALPHA0 =,F5.2,8H DEGREES,3X,5HCM0 =,F7.4,3X,
     *5HETA =,F6.3)
      GOTO11
C...PEN CARD
  400 IF (NUPA.GE.1.AND.NUPA.LE.4) CALL NEWPEN(NUPA)
      GO TO 11
C...SCAL CARD
  500 CALL DIA(X,Y,NQ,THK)
      THKP=100.*THK
      SCALFA=.1*PUFF(1)/THKP
      DO 510 I=1,NQ
  510 Y(I)=SCALFA*Y(I)
  520 NQVT=NQ/4
      CH1=X(1)
      CH2=X(NQ)
      YCH1=Y(1)
      YCH2=Y(NQ)
      DO 501 N=2,NQVT
      XD=X(N)
      IF (XD.GT..94*CH1) DLT=(Y(N)-YCH1)/(BOGEN*(CH1-XD))
      NS=NQ-N+1
      XD=X(NS)
      IF (XD.GT..94*CH2) DLTU=(YCH2-Y(NS))/(BOGEN*(CH2-XD))
  501 CONTINUE
      MSPLI=0
      GO TO 11
C...SYM CARD
  600 XMIN=1000.
      DO 620 I=1,NQ
         IF (X(I).GT.XMIN.OR.Y(I).LT.0.) GO TO 620
         XMIN=X(I)
         INDEX=I
         XF(I)=X(I)
         YF(I)=Y(I)
  620 CONTINUE
      IF (X(INDEX).EQ.0.) GO TO 630
      INDEX=INDEX+1
      XF(INDEX)=0.
      YF(INDEX)=0.
  630 NNQ=2*INDEX-1
      K=1
      DO 640 I=INDEX,NQ
      XP(K)=X(I)
      YP(K)=Y(I)
  640 K=K+1
      NLO=NQ-INDEX+1
      L=INDEX-1
      DO 650 I=1,L
      K=INDEX-I
      J=INDEX+I
      XF(J)=X(K)
  650 CALL FTLUP(XF(J),YF(J),1,NLO,XP,YP)
      DO 660 I=1,NNQ
      X(I)=XF(I)
  660 Y(I)=YF(I)
      NQ=NNQ
      X(INDEX)=0.
      Y(INDEX)=0.
      L=INDEX-1
      DO 670 I=1,L
      K=INDEX-I
      J=INDEX+I
      THKP=.5*(Y(K)-Y(J))
      Y(K)=THKP
  670 Y(J)=-THKP
      GO TO 520
C...TFAC CARD
  700 TFAC=.1*PUFF(1)
      WRITE (*,710) TFAC
  710 FORMAT(/1X,'TFAC HAS BEEN CHANGED TO ',F5.3)
      GO TO 11
      END
      SUBROUTINE PADD(X,Y,BETA,NQ,MEI,KEI,XST)
      DIMENSION X(65),Y(65),BETA(65)
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
      IF(MSPLI.EQ.0)CALL SPLITZ(X,Y,NQ,BETA)
      M=MEI
      K=KEI
      IF(M.NE.0)GO TO 14
      XV=X(1)
      DO 10 I=2,NQ
      XM=X(I)
      DX=XM-XV
      IF(K.GT.0.AND.DX.LT.0.)GO TO 10
      IF((XM-XST)*DX.GE.0.)GO TO 12
   10 XV=XM
      I=NQ
   12 M=I-1
      K=1
   14 X0=X(1)
      XM=X(M)
      XMP=X(M+1)
      DX=XMP-XM
      PH1=ATAN2(SQRT(XM*(X0-XM)),XM-.5*X0)
      PH2=ATAN2(SQRT(XMP*(X0-XMP)),XMP-.5*X0)
      DY=Y(M+1)-Y(M)
      DLTA=ATAN2(DX,-DY)
      GA=BETA(M)-DLTA
      GAS=DLTA-BETA(M+1)
      TG=SIN(GA)/COS(GA)
      TGS=SIN(GAS)/COS(GAS)
      KS=NQ
    2 KR=KS+K
      X(KR)=X(KS)
      Y(KR)=Y(KS)
      BETA(KR)=BETA(KS)
      KS=KS-1
      IF(KS.GT.M)GO TO 2
      FKP=FLOAT(K+1)
      DO 4 KE=1,K
      XI=FLOAT(KE)/FKP
      IF(XM.GE.XST.OR.XMP.GE.XST)XI=(.5*X0*(1.+COS(PH1+XI*(PH2-PH1)))
     1  -XM)/DX
      IF(MEI.EQ.0)XI=(XST-XM)/(XMP-XM)
      ETA=XI*(1.-XI)*(TG*(1.-XI)+TGS*XI)
      ME=M+KE
      X(ME)=X(M)+XI*DX-ETA*DY
      Y(ME)=Y(M)+ETA*DX+XI*DY
    4 BETA(ME)=ATAN(TG*(1.-XI)*(1.-3.*XI)+TGS*XI*(2.-3.*XI))+DLTA
      NQ=NQ+K
      RETURN
      END
 
      SUBROUTINE LSQA (AVI,K,VL,RES)
      DIMENSION AVI(5,5)
      RES=-9.
      A1=AVI(K,1)
      IF (A1.EQ.0.) RETURN
      RES=AVI(K,4)
      A2=AVI(K,2)
      A3=AVI(K,3)
      A5=AVI(K,5)
      DET=A1*A3-A2*A2
      IF (ABS(DET).LT.1.E-9) RETURN
      RES=((RES*A3-A2*A5)+VL*(A1*A5-RES*A2))/DET
      RETURN
      END
 
      SUBROUTINE LSQP (AVI,K,U,V)
      DIMENSION AVI(5,5)
      AVI(K,1)=AVI(K,1)+1.
      AVI(K,2)=AVI(K,2)+U
      AVI(K,3)=AVI(K,3)+U*U
      AVI(K,4)=AVI(K,4)+V
      AVI(K,5)=AVI(K,5)+U*V
      RETURN
      END
 
      SUBROUTINE MOMENT (X,Y,NQ,NALA,NALE)
      CHARACTER*2 NZPZ,NZT,NAMP,NNESE,NUFF
      CHARACTER*4 CPV,ALTX
      DIMENSION X(NQ),Y(NQ)
      COMMON/CHARS/NAMP(12),CPV(2),ALTX(4,2),NNESE,NUFF(80)
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      DATA XDS,YDS/.25,0./,KS/1/
      IF(NQ.NE.0)GO TO 3
      XDS=XDA
      YDS=YDA
      KS=NALA
      GO TO 34
    3 IF(MOMAG.NE.1)GO TO 4
      NZT=NZPZ(2,NAL+4)
      WRITE(IDRU,1)NZT,NAMP,XDS,YDS
    1 FORMAT(A1,8HAIRFOIL ,12A1,21H  MOMENTS, CM REL. X=,F5.3, 3H Y=,
     * F5.3)
      IF(KS.NE.1)WRITE(IDRU,6)
    6 FORMAT(1H+,55X,16H (=SECOND HINGE))
      NZT=NZPZ(1,0)
      WRITE(IDRU,2)NZT,DEFLG,XDA,YDA
    2 FORMAT(A1,6H ALPHA,6X,2HCM,9X,11HCR    BETA=,F6.2,18H DEG., HINGE
     *AT X=,F5.3,3H Y=,F5.3)
    4 DO 31 M=NALA,NALE
      XD=XDS
      YD=YDS
      DO 20 K=1,2
      SWITCH=1.
      DRQV=-1.
      XV=X(NQ)
      YV=Y(NQ)
      DX=XV-XD
      DY=YV-YD
      RQV=DX*DX+DY*DY
      VQV=VPR(NQ,M)**2
      IF(FMACH.NE.0.)CALL CPCOR(VQV,VQV)
      CX=0.
      CY=0.
      CR=0.
      DO 10 I=1,NQ
      XI=X(I)
      YI=Y(I)
      DX=XI-XD
      DY=YI-YD
      RQ=DX*DX+DY*DY
      DRQ=RQ-RQV
      VQ=VPR(I,M)**2
      IF(FMACH.NE.0.)CALL CPCOR(VQ,VQ)
      IF(K.EQ.KS)GO TO 5
      CX=CX+(VQ+VQV)*(YI-YV)
      CY=CY-(VQV+VQ)*(XI-XV)
      IF(XD.EQ.0.)GO TO 5
      IF(DRQV.GE.0..OR.DRQ.LT.0.)GO TO 5
      CR=CR+SWITCH*RQV*VQV
      SWITCH=-SWITCH
    5 IF(SWITCH.GT.0.)CR=CR+RQ*VQV-RQV*VQ
      YV=YI
      XV=XI
      RQV=RQ
      DRQV=DRQ
   10 VQV=VQ
      CR=.25*CR
      IF(K.EQ.1)CM=CR
      XD=XDA
   20 YD=YDA
      AR=ALV(M)-ALN/BEMACH
      CL=(CY*COSG(AR)-CX*SING(AR))*.5
      CRL(M)=CL
      IF (IVI.NE.0) GO TO 22
      CML(M)=CM
      GO TO 24
   22 CALL LSQP (AVI,IVI,ALV(M),CM)
      CALL LSQP(BVI,IVI,CL,ALV(M))
   24 IF(MOMAG.NE.1) GO TO 31
      NZT=NZPZ(1,0)
   30 WRITE(IDRU,32)NZT,ALV(M),CM,CR
   31 CONTINUE
   32 FORMAT(A1,F6.2,2F11.6)
   34 RETURN
      END
 
      SUBROUTINE CPCOR(VQ,VQC)
      COMMON/PRAL/G(17),NG(2),H(29),NH(2),GG(655),FMACH,BEMACH,IG(6),
     1 DU(3),IDU(2)
      FMQ=FMACH*FMACH
      VQC=1.-(1.42857143/FMQ)*((1.+.2*(1.-VQ)*FMQ)**3.5-1.)
      RETURN
      END
 
      SUBROUTINE SPLITZ(X,Y,NQ,BETA)
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      COMMON/PLTM/MGC,MPL,XZEH,YZEH,MSPLI
      COMMON GAP1(1175),IGAP(6),GAP3(753),U(121),V(121),DS(121)
      DIMENSION X(NQ),Y(NQ),BETA(NQ)
      DATA DBSOLL/1.E-6/
      MSPLI=1
      NK=NQ-1
      DO 10 N=1,NQ
      XN=X(N)
      YN=Y(N)
      IF(N.EQ.1)GO TO 8
      DX=XN-XV
      DY=YN-YV
      M=N-1
      AN=SQRT(DX*DX+DY*DY)
      DS(M)=AN
      IF(M.EQ.1)GO TO 6
      U(M)=DXV*DX+DYV*DY
      V(M)=DXV*DY-DYV*DX
      DD=-(AV/(AV+AN))*ATAN2(V(M),U(M))
      BETA(M)=SIN(DD)/COS(DD)
    6 AV=AN
      DXV=DX
      DYV=DY
    8 XV=XN
   10 YV=YN
      BETA(NQ)=0.
      NIT=0
      DBM=0.
   12 NIT=NIT+1
      DBM=0.
      AV=DS(1)
      GS=BETA(2)
      GN=.5*GS
      DO 20 N=2,NK
      UN=U(N)
      VN=V(N)
      GP=(UN*GS+VN)/(VN*GS-UN)
      AN=DS(N)
      GPS=BETA(N+1)
      IF(N.EQ.NK)GPS=.5*GP
      GSQ=GS*GS
      GPQ=GP*GP
      E=AV*(2.*GP-GPS)*(1.+GPQ)-AN*(2.*GS-GN)*(1.+GSQ)
      ES=AN+AV
      IF(GSQ+GPQ.LT..09)GO TO 18
      ES=AV*(1.+3.*GPQ-GP*GPS)*(UN-GP*VN)/(UN-GS*VN)+AN*(1.+3.*GSQ
     1 -GS*GN)
   18 DE= .5*E/ES
      IF(DBM.LT.ABS(DE))DBM=ABS(DE)
      GS=GS+DE
      BETA(N)=GS
      AV=AN
      GN=(UN*GS+VN)/(VN*GS-UN)
   20 GS=GPS
      IF(DBM.GT.DBSOLL.AND.NIT.LE.15)GO TO 12
      DO 30 N=1,NQ
      XN=X(N)
      YN=Y(N)
      IF(N.EQ.1)GO TO 28
      DX=XN-XV
      DY=YN-YV
      DLT=ATAN2(DX,-DY)
      IF(N.EQ.2)BETA(1)=DLT+ATAN(.5*BETA(2))
      BETA(N)=DLT-ATAN(BETA(N))
   28 XV=XN
   30 YV=YN
      BETA(NQ)=DLT-ATAN(.5*GN)
      RETURN
      END
 
      SUBROUTINE FLAP(X,Y,BETA,NQ,XDA,YDA,ARCL,ARCLU,DEFL,XF,YF,BETAF,
     * NQF)
      DIMENSION X(NQ),Y(NQ),BETA(NQ),XF(NQ),YF(NQ),BETAF(NQ),NAB(2,2),
     1 NPA(2)
      DO 2 N=1,NQ
      XF(N)=X(N)
      YF(N)=Y(N)
    2 BETAF(N)=BETA(N)
      NQF=NQ
      NSUCH=NQ/2
      DO 22 M=1,2
      AQ=1.E10
      DO 10 N=1,NSUCH
      NP=N+(M-1)*NSUCH
      DTX=XDA-X(NP)
      DTY=YDA-Y(NP)
      ANQ=DTX*DTX+DTY*DTY
      IF(ANQ.GE.AQ)GO TO 10
      NDP=NP
      AQ=ANQ
      DBT=ATAN2(DTY,DTX)-BETA(NP)
   10 CONTINUE
      IF(SIN(DBT).GE.0.)NDP=NDP-1
      XVDP=X(NDP)
      YVDP=Y(NDP)
      DX=X(NDP+1)-XVDP
      DY=Y(NDP+1)-YVDP
      DLT=ATAN2(DX,-DY)
      GA=BETA(NDP)-DLT
      GAS=DLT-BETA(NDP+1)
      TG=SIN(GA)/COS(GA)
      TGS=SIN(GAS)/COS(GAS)
      U=XDA-XVDP
      V=YDA-YVDP
      SDL=SIN(DLT)
      CDL=COS(DLT)
      DL=SQRT(DX*DX+DY*DY)
      XIDA=(U*SDL-V*CDL)/DL
      ETADA=(U*CDL+V*SDL)/DL
      XIT=XIDA
   12 XKP=1.-XIT
      DEIT=ETADA-XIT*XKP*(XKP*TG+XIT*TGS)
      XIN=XIDA+DEIT*(XKP*(1.-3.*XIT)*TG+XIT*(3.*XKP-1.)*TGS)
      IF(ABS(XIN-XIT).LT..00001)GO TO 14
      XIT=XIN
      GO TO 12
   14 AA=DL*SQRT((XIT-XIDA)*(XIT-XIDA)+DEIT*DEIT)
      AL=ARCL+SIN(.5*DEFL)*SIGN(AA,DX*DEIT)
      IF(ARCLU.GT..00001.AND.DX.GT.0.)AL=AL-ARCL+ARCLU
      IF(AL.LT..0001*X(1))AL=.0001*X(1)
      XST=XKP
      DO 20 L=1,2
      ND=3-2*L
      ALR=-XST*DL-AL
      NR=NDP+L-1
   16 NV=NR+ND
      DXS=X(NV)-X(NR)
      DLS=SQRT((Y(NV)-Y(NR))**2+DXS*DXS)
      IF(ALR.GE.0.)GO TO 18
      ALR=ALR+DLS
      NR=NR-ND
      DXLV=DXS/DLS
      GO TO 16
   18 XBR=X(NV)+ALR*DXLV
      NOU=2*M-3
      CALL PADD(XF,YF,BETAF,NQF,0,NOU,XBR)
      NAB(M,L)=NV+2*M-1
   20 XST=XIT
   22 CONTINUE
      CDF=COS(DEFL)
      SDF=SIN(DEFL)
      M=1
      N=1
      DO 30 L=1,NQF
      XF(N)=XF(L)
      YF(N)=YF(L)
      BETAF(N)=BETAF(L)
      IF(L.EQ.NAB(M,1))NPA(M)=N
      IF(L.GT.NAB(1,1).AND.L.LT.NAB(2,2))GO TO 26
      BETAF(N)=BETAF(N)-DEFL
      DX=XF(N)-XDA
      DY=YF(N)-YDA
      XF(N)=XDA+DX*CDF+DY*SDF
      YF(N)=YDA-DX*SDF+DY*CDF
   26 IF(L.EQ.NSUCH)M=2
      IF((L-NAB(M,1))*(L-NAB(M,2)).GE.0)N=N+1
   30 CONTINUE
      NQF=N-1
      CALL PADD(XF,YF,BETAF,NQF,NPA(2),3,XF(1))
      CALL PADD(XF,YF,BETAF,NQF,NPA(1),3,XF(1))
      RETURN
      END
 
      SUBROUTINE VGEO(XF,YF,NQF,PUFF,NUPU,X,Y,BETA,NQ)
      CHARACTER NZPZ*2,NZT*2,TXT*4
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      DIMENSION XF(1),YF(1),X(1),Y(1),BETA(1),PUFF(1),TXT(2)
      DATA TXT/'UPPE','LOWE'/
      GO TO(2,10,10,20),NUPU
C   DELETE POINTS
    2 DO 4 I=1,NQF
      X(I)=XF(I)
    4 Y(I)=YF(I)
      NQ=NQF
      X0=X(1)
      DO 8 I=1,14
      NPT=INT(PUFF(I))
      NDL=INT(FCT5*PUFF(I)+.1)-100*NPT+1
      IF(NPT.EQ.0)RETURN
      NZT=NZPZ(1,0)
      WRITE(IDRU,102)NZT,NPT
  102 FORMAT (A1,15H DELETED POINT ,I3)
      IF(NDL.EQ.1)GO TO 5
      NWR=NPT+NDL-1
      WRITE(IDRU,103)NWR
  103 FORMAT (1H+,14X,1HS,4X,7HTHROUGH,I3)
    5 NQ=NQ-NDL
      IF(NPT.GT.NQ)GO TO 8
      DO 6 K=NPT,NQ
      KS=K+NDL
      X(K)=X(KS)
    6 Y(K)=Y(KS)
    8 CONTINUE
      RETURN
C   INSERT POINTS
   10 DO 16 I=1,14,2
      PFZ=X0*PUFF(I)/FCT5
      IF(PFZ.EQ.0.)RETURN
      PFY=X0*PUFF(I+1)/FCT5
      NZT=NZPZ(1,0)
      WRITE(IDRU,105)NZT,TXT(NUPU-1),PFZ,PFY
  105 FORMAT (A1,19H INSERTED POINT ON ,A4,20HR SURFACE AT   X/C =,F7.4,
     *3X,5HY/C =,F7.4)
      NQ=NQ+1
      IF(NUPU.EQ.3)GO TO 14
      DO 12 K=2,NQ
      KS=NQ+1-K
      X(KS+1)=X(KS)
   12 Y(KS+1)=Y(KS)
      X(1)=PFZ
      Y(1)=PFY
      GO TO 16
   14 X(NQ)=PFZ
      Y(NQ)=PFY
   16 CONTINUE
      RETURN
C   INSERT INTERMEDIATE POINTS
   20 CALL SPLITZ(X,Y,NQ,BETA)
      DO 22 I=1,22
      PFZ=PUFF(I)
      IF(PFZ.EQ.0.)RETURN
      MEIG=INT(PFZ)
      MEI=MEIG/10
      KEI=MEIG-10*MEI
      XSTX=ABS(PFZ-FLOAT(MEIG))
   22 CALL PADD(X,Y,BETA,NQ,MEI,KEI,XSTX)
      RETURN
      END
 
      SUBROUTINE PANEL(X,Y,BETA,ITIC,NK,A,GAMMA,CAE)
      CHARACTER*2 NZPZ,NZT,NAMP,NNESE,NUFF
      CHARACTER*4 ALTX,CPV
      COMMON GAP1(506),AGAM(6),GAP2(242),DS(122),VF(121),ARG(121),
     1 GAP3(57),IGAP(2),NQ,IGAQ(3),CM,ETA,ABFA,PI,BOGEN
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      COMMON/CHARS/NAMP(12),CPV(2),ALTX(4,2),NNESE,NUFF(80)
      COMMON/VIK/VIK1(121),VIK2(121),ALN1
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      DIMENSION GAMMA(NK,2),A(NK,NK),BETA(121),DELTA(120),G(121,2),
     1CAE(2),ZZL(120),DA(4),DSP(121),X(121),Y(121)
      LOGICAL WAKE
      DATA FED/.00001/
      MAUS=IDRU
      NAGA=INT(AGAM(5))
      MMA=0
    1 DELTA(1)=.5*(BETA(1)+BETA(NQ))-PI
      XHM=X(NQ)
      YHM=Y(NQ)
      DO 2 N=1,NQ
      XN=X(N)
      YN=Y(N)
      DX=XN-XHM
      DY=YN-YHM
      DL=SQRT(DX*DX+DY*DY)
      DSP(N)=DL
      IF(N.NE.1)GO TO 22
      WAKE=DL.GT..0001*XN
      DLB=DL
      IF(.NOT.WAKE)GO TO 24
   22 DELTA(N)=ATAN2(DX,-DY)
   24 XHM=XN
    2 YHM=YN
      IF(DELTA(1).GT.0.)DELTA(1)=DELTA(1)-2.*PI
      EDGE1=BETA(1)-DELTA(1)
      EDGE2=BETA(NQ)-DELTA(1)-2.*PI
      COSAB=COS(EDGE1)
      SINAB=SIN(EDGE1)
      COSAQ=COS(EDGE2)
      SINAQ=SIN(EDGE2)
      ZZL(1)=PI*.5*(SINAB-SINAQ)+COSAB+COSAQ
      DO 20 M=1,NQ
      IF(.NOT.WAKE.AND.M.EQ.NQ)GO TO 20
      BEM=BETA(M)
      XMRE=X(M)
      YMRE=Y(M)
      IF(M.GT.1.AND.M.LT.NQ)GO TO300
      XMRE=.5*(X(1)+X(NQ))
      YMRE=.5*(Y(1)+Y(NQ))
      BEM=DELTA(1)+FLOAT(M/NK)*.5*PI
  300 CBM=SIN(BEM)
      SBM=-COS(BEM)
      IF(M.LE.NK)A(M,1)=0.
      G(M,1)=-CBM*6.283185
      G(M,2)=-SBM*6.283185
      XNR=XN
      YNR=YN
      DO 9 NKOR=1,NQ
      XNP=X(NKOR)
      YNP=Y(NKOR)
      DAT=0.
      DAS=0.
      DAY=0.
      IF(.NOT.WAKE.AND.(NKOR.EQ.1.OR.NKOR.EQ.M+NK))GO TO 8
      IF (NKOR.NE.1.OR.M.NE.NQ) GO TO 302
      DAUQ=PI/4.
      GO TO 8
  302 N=NKOR-1
      IF(N.EQ.0)N=1
      DU=XNP-XNR
      DV=YNP-YNR
      DL=DSP(NKOR)
      CP=DU/DL
      SP=DV/DL
      GA=BETA(N)-DELTA(NKOR)
      GAS=DELTA(NKOR)-BETA(NKOR)
      XAA=XNR
      YAA=YNR
      DLR=DL
      IF(M.NE.NKOR.AND.M.NE.NKOR-1)GO TO 200
      IF(M.NE.1.AND.M.NE.NQ)GO TO 4
      IF(.NOT.WAKE)GO TO 6
      IF(NKOR.EQ.1)GO TO 7
  200 DX=XMRE-XNR
      DY=YMRE-YNR
      U=(DX*CP+DY*SP)/DL
      V=(DY*CP-DX*SP)/DL
      PK=1.
      PKL=1.
      IF(NKOR.EQ.1)GO TO 204
      EMAX=ABS(GA+GAS)/8.
      RAB=ABS(V)
      IF(U.LT.0..OR.U.GT.1.)RAB=AMAX1(RAB,ABS(U),ABS(U-1.))
      FAB=EMAX/(FED*RAB)
      IF(FAB.LT.1.)GO TO 204
      PK =FLOAT(INT(FAB**.333333)+1)
      TG=SIN(GA)/COS(GA)
      TGS=SIN(GAS)/COS(GAS)
  202 XI=PKL/PK
      ET=XI*(1.-XI)*(TG*(1.-XI)+TGS*XI)
      XZ=XAA+XI*DU-ET*DV
      YZ=YAA+ET*DU+XI*DV
      DUZ=XZ-XNR
      DVZ=YZ-YNR
      DL =SQRT(DUZ*DUZ+DVZ*DVZ)
      CP=DUZ/DL
      SP=DVZ/DL
      DX=XMRE-XNR
      DY=YMRE-YNR
      U=(DX*CP+DY*SP)/DL
      V=(DY*CP-DX*SP)/DL
  204 VQ=V*V
      UQ=U*U
      DEN1=U-.333333
      DEN = DEN1*DEN1+VQ
      IF(DEN.LT.10000.)GO TO 205
      WU=.5*V/DEN
      WV=-.5*DEN1/DEN
      DEN1=U-.6666667
      DEN=DEN1*DEN1+VQ
      WUS=.5*V/DEN
      WVS=-.5*DEN1/DEN
      DWU=0.
      DWV=0.
      GO TO 206
  205 ULM=U-1.
      TAD=ATAN2(V,U*ULM+VQ)
      TAL=.5*ALOG((VQ+UQ)/(VQ+ULM*ULM))
      WU=(1.-U)*TAD+V*TAL
      WV=V*TAD-(1.-U)*TAL-1.
      WUS=U*TAD-V*TAL
      WVS=1.-U*TAL-V*TAD
      DWU=(U-UQ+VQ)*TAD+V*(2.*U-1.)*TAL-V
      DWV=(UQ-VQ-U)*TAL+(2.*U-1.)*(V*TAD-.5)
  206 FNMX=WU*CP-WV*SP
      FNMY=WV*CP+WU*SP
      FNMXS=WUS*CP-WVS*SP
      FNMYS=WVS*CP+WUS*SP
      DFX=DWU*CP-DWV*SP
      DFY=DWV*CP+DWU*SP
      DAX=(FNMX*CBM+FNMY*SBM)/PK
      DAZ=(FNMXS*CBM+FNMYS*SBM)/PK
      DAU=DFX*CBM+DFY*SBM
      IF (NKOR.NE.1) GO TO 208
      DAX=DAX*COSAB+(FNMX*SBM-FNMY*CBM)*SINAB
      DAZ=-DAZ*COSAQ-(FNMXS*SBM-FNMYS*CBM)*SINAQ
  208 DAT=DAT+DAX*(PK+1.-PKL)+DAZ*(PK-PKL)
      DAS=DAS+DAX*(PKL-1.)+DAZ*PKL
      DAY=DAY+(DAU/PK+DAX*(PKL-1.)*(PK+1.-PKL)+DAZ*PKL*(PK-PKL))/PK
      IF(PKL.GT.PK-.01)GO TO 8
      PKL=PKL+1.
      XNR=XZ
      YNR=YZ
      GO TO 202
    4 FLOM=FLOAT(NKOR-M)
      DAS=.5*GAS+(FLOM-.3333333)*(GA-GAS)
      DAT=.5*GA+(FLOM-.6666667)*(GA-GAS)+FLOM*PI
      DAY=(GA+GAS+2.*(2.*FLOM-1.)*(GA-GAS))/12.
      GO TO 8
    6 DAT=ALOG(DSP(NQ)/DL)
      DAS=-1.
      GO TO 8
    7 DAS=PI*.5*(COSAB-COSAQ)-SINAB-SINAQ
    8 DO 100 L=1,4
  100 DA(L)=0.
      IF(NKOR.EQ.1)GO TO 106
      IF(NKOR.GE.3)FM=DSP(NKOR-1)/DLR
      IF(NKOR.LE.NK)FP=DSP(NKOR+1)/DLR
      IF(NKOR.EQ.2)GO TO 102
      IF(NKOR.EQ.NQ)GO TO 104
      DAH=DAY/2.
      DA(1)=-DAH/(FM*(FM+1.))
      DA(2)=DAH*(1./FM-1./(FP+1.)) + DAT
      DA(3)=DAH*(1./FP-1./(FM+1.)) + DAS
      DA(4)=-DAH/(FP*(FP+1.))
      GO TO 108
  102 DA(2)=DAT-DAY/(FP+1.)
      DA(3)=DAS+DAY/FP
      DA(4)=-DAY/(FP*(FP+1.))
      GO TO 108
  104 DA(1)=-DAY/(FM*(FM+1.))
      DA(2)=DAT+DAY/FM
      DA(3)=DAS-DAY/(FM+1.)
      GO TO 108
  106 DA(3)=DAS+DAT
  108 DO 116 L=1,4
      NE=NKOR+L-3
      IF(NE.GT.NQ.OR.NE.LT.1)GO TO 116
      IF(NE.LT.NQ)GO TO 110
      IF(M.LT.NQ)A(M,1)=A(M,1)-DA(L)
      IF(M.EQ.NQ)ZZL(1)=ZZL(1)-DA(L)
      GO TO 116
  110 IF(M.EQ.NQ)GO TO 112
      IF(L.EQ.4)A(M,NE)=DA(L)
      IF(L.LT.4)A(M,NE)=A(M,NE)+DA(L)
      GO TO 116
  112 IF(L.EQ.4)ZZL(NE)=DA(L)
      IF(L.LT.4)ZZL(NE)=ZZL(NE)+DA(L)
  116 CONTINUE
   10 XNR=XNP
    9 YNR=YNP
   20 CONTINUE
      IF(.NOT.WAKE)A(1,NK)=A(1,NK)-1.
      IF(WAKE)GO TO 139
      DO 136 N=1,NK
  136 ZZL(N)=0.
      ZZL(1)=1.
      W=(1.+DSP(3)/DSP(2))**.66667
      ZZL(3)=.5/(W-1.)
      ZZL(2)=-W*ZZL(3)
      W=(1.+DSP(NK)/DSP(NQ))**.66667
      ZZL(NK-1)=-.5/(W-1.)
      ZZL(NK)=-W*ZZL(NK-1)
  139 DO 144 N=1,NK
      DO 141 M=1,2
      GR=0.
      DO 140 L=1,NK
  140 GR=GR+G(L,M)*A(L,N)
      IF(WAKE)GR=GR+G(NQ,M)*ZZL(N)
  141 GAMMA(N,M)=GR
      DO 143 M=N,NK
      BW=0.
      DO 142 L=1,NK
  142 BW=BW+A(L,N)*A(L,M)
      BW=BW+ZZL(M)*ZZL(N)
  143 DELTA(M)=BW
      DO 144 M=N,NK
  144 A(M,N)=DELTA(M)
      DO 146 N=1,NK
      DO 146 M=N,NK
  146 A(N,M)=A(M,N)
      EPS=0.
      CALL GAUSS(A,GAMMA,NK,2,EPS)
      DO 152 M=1,2
      CA=0.
      DO 150K=2,NK
  150 CA=CA+(DSP(K)+DSP(K+1))*GAMMA(K,M)
  152 CAE(M)=CA/X(1)
      AL0=ATAN2(CAE(1),CAE(2))/BOGEN
      IF(NAGA.EQ.0)GO TO 48
      NAG2=INT(AGAM(1))
      IF(NAG2.GT.1)NAG2=1
      NZFR=NAG2*(NQ-NAL)+NAL+3
      IF(MMA.EQ.1.AND.NAGA.LT.3)NZFR=0
      NZT='0'
      WRITE(MAUS,42)NZT,NAMP,CAE,AL0
   42 FORMAT(A1,21HPANEL METHOD AIRFOIL ,12A1,4H CL=,F8.5,1H,,F8.5,8H AL
     *PHA0=,F5.2,5H DEG.)
      IF(NAGA.LT.3)GO TO 48
      NZT=NZPZ(1,0)
      WRITE (MAUS,43) NZT
   43 FORMAT (A1,3H  N,7X,1HX,9X,1HY,8X,4HBETA,6X,6HGAMMA1,5X,6HGAMMA2,
     *5X,2HDS)
      DO 44 K=1,NK
      NZT=NZPZ(1,0)
      KD=K-1
   44 WRITE(MAUS,46)NZT,KD,X(K),Y(K),BETA(K),GAMMA(K,1),GAMMA(K,2),
     1DSP(K+1)
   46 FORMAT (A1,I3,2F10.5,3F11.5,F9.5)
      NZT=NZPZ(1,0)
      WRITE(MAUS,46)NZT,NK,X(NQ),Y(NQ),BETA(NQ),GAMMA(1,1),GAMMA(1,2)
   48 IF(MMA.NE.0)GO TO 52
      ETA=.5*CAE(2)/PI
      IF(ITIC.NE.0)GO TO 51
      DO 47 K=1,NK
   47 DS(K)=DSP(K+1)
      ALN=AL0
   51 IF(FMACH.EQ.0.)GO TO 56
      DO 49 K=1,NQ
      CALL VGAMMA(K,VIK1(K),VIK2(K))
   49 Y(K)=Y(K)*BEMACH
      ALN1=AL0
      CALL SPLITZ(X,Y,NQ,BETA)
      MMA=1
      GO TO 1
   52 DO 54 K=1,NQ
   54 Y(K)=Y(K)/BEMACH
      CALL SPLITZ(X,Y,NQ,BETA)
   56 IF(ITIC.NE.0)GO TO 59
      ITP=2
      DO 50 K=1,NQ
   50 CALL VGAMMA(K,VF(K),ARG(K))
   59 RETURN
      END
 
      SUBROUTINE WANDEL(N,NF,M,MHB)
      CHARACTER*2 NF(M),NVGL(11)
      DATA NVGL/'0','1','2','3','4','5','6','7','8','9',' '/
      NW=N
      DO 1 K=1,M
      MR=M+1-K
      L=11
      IF(NW.EQ.0.OR.K.LE.MHB)GO TO 1
      NX=NW/10
      L=NW-10*NX+1
      NW=NX
    1 NF(MR)=NVGL(L)
      RETURN
      END
 
      FUNCTION VPR(N,I)
      COMMON GAP(876),VF(121),ARG(121),GAPS(57),IZZ,KFU,NQ
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      DATA DALR/99./
      IF(ITP.GT.1.OR.IVI.NE.0)GO TO 2
      VPZ=VF(N)*COSG(180.*FLOAT(N-1)/FLOAT(NQ-1)-ALV(I))
      GO TO 8
    2 DAL=ALV(I)-ALN
      IF(DAL.EQ.DALR)GO TO 4
      CDAL=COSG(DAL)
      SDAL=SING(DAL)
      DALR=DAL
    4 IF(IVI.GE.1.AND.IVI.LE.5)GO TO 5
      V1=VF(N)
      V2=ARG(N)
      GO TO 6
    5 CALL VGAMMA(N,V1,V2)
    6 VPZ=CDAL*V1+SDAL*V2
      IF(FMACH.NE.0.)CALL MACOR(VPZ,N,I,VPZ)
    8 VPR=VPZ
      RETURN
      END
 
      SUBROUTINE MACOR(VA,N,I,VC)
      CHARACTER*2 NZPZ,IZT
      COMMON GAP(1175),IGAP(6),HAP(382),BETA(121)
      COMMON/VIK/VIK1(121),VIK2(121),ALN1
      COMMON/PRAL/G(3),ALV(14),NG(2),H(29),NH(2),GG(655),FMACH,BEMACH,
     1 IG(6),GA(3),IGA(2)
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      DATA DAR/99./
      DA=ALV(I)-ALN1
      IF(DA.EQ.DAR)GO TO 2
      CDA=COSG(DA)
      SDA=SING(DA)
      DAR=DA
    2 VIK=CDA*VIK1(N)+SDA*VIK2(N)
      BWQ=1.-FMACH*FMACH*(1.-FMACH*(1.-VIK*VIK))
      IF(BWQ.GE.0.)GO TO 3
      VZ=ABS(VIK)
      IZT=NZPZ(2,0)
      WRITE(IDRU,4)IZT,FMACH,VZ
    4 FORMAT(A1,11HWARNING, M=,F5.3,5H,VIK=,F5.3,37H TOO HIGH, MACH-CORR
     *ECTION IMPOSSIBLE)
      GO TO 5
    3 BQ=BEMACH*BEMACH
      D=BETA(N)
      CD=COS(D)
      SD=SIN(D)
      CDQ=CD*CD
      SDQ=SD*SD
      VZ=((SQRT(BWQ)-1./BEMACH)*ABS(SD)+ABS(VA)*SQRT(SDQ/BQ+CDQ))/SQRT(
     1 BWQ*SDQ+CDQ)
    5 VC=SIGN(VZ,VA)
      RETURN
      END
 
      SUBROUTINE VGAMMA(N,V1,V2)
      COMMON G(1175),I(2),NQ,J(3),H(511),GAMMA(242)
      NS=N
      F=1.
      IF(N.NE.NQ)GO TO 1
      NS=1
      F=-1.
    1 ND=NS+NQ-1
      V1=F*GAMMA(NS)
      V2=F*GAMMA(ND)
      RETURN
      END
 
      SUBROUTINE FIXLES
      CHARACTER*4 ALTX,CPV
      CHARACTER*2 NAM(8),NAMP,NNESE,NUFF
      COMMON/CHARS/NAMP(12),CPV(2),ALTX(4,2),NNESE,NUFF(80)
      COMMON GAP(512),X(121),Y(121),GAPS(421),IDU,KDU,NQ,IGA(3),GAPT(3)
     1 ,PI,BOGEN
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14)
     1,DARF,ITIT1,ITIT2,DUM(657),IG1(6),DUS(3),IG2(2)
C
C  NOTE: I HAVE NOT ADOPTED THE NEW FXPR CARD OPTIONS AS PER
C  THE NEW VERSION.  THIS IS THE SAME VERSION AS THE OLD ONE.
C
      READ (ILES,2) NAMP
2     FORMAT(12A1)
      READ (ILES,3) MUP,MLOW
3     FORMAT (2I5)
      NQ=MUP+MLOW-1
      CALL RDC(X,MUP,-1,1)
      CALL RDC(Y,MUP,-1,1)
      CALL RDC(X,MUP,1,NQ)
      CALL RDC(Y,MUP,1,NQ)
      NQVT = NQ/4
      CH1 = X(1)
      CH2 = X(NQ)
      YCH1 = Y(1)
      YCH2 = Y(NQ)
      DO 100 N=2,NQVT
      XD=X(N)
      IF(XD.GT..94*CH1)DLT=(Y(N)-YCH1)/(BOGEN*(CH1-XD))
      NS=NQ-N+1
      XD=X(NS)
      IF(XD.GT..94*CH2)DLTU=(YCH2-Y(NS))/(BOGEN*(CH2-XD))
  100 CONTINUE
      RETURN
      END
 
      SUBROUTINE RDC(ARR,NB,ND,NE)
      DIMENSION ARR(121),BF(8)
      COMMON/EA/ILES,IDRU,ISTA,MARD,DUM(5)
      N=NB
    5 READ (ILES,10) BF
   10 FORMAT (8F10.5)
      DO 15 M=1,8
      ARR(N)=BF(M)
      IF (N.EQ.NE) RETURN
   15 N=N+ND
      GO TO 5
      END

      SUBROUTINE SMOOTH(IS,X,Y,BT,NQ,A)
      CHARACTER*2 NZPZ,NZT
      COMMON GAP1(1175),IGAP(6),GAP3(753),XPL(121),YPL(121)
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      DIMENSION X(NQ),Y(NQ),BT(NQ)
      LOGICAL A
      EXTERNAL A
      DATA HS/.4/
      IF(MSPLI.EQ.0)CALL SPLITZ(X,Y,NQ,BT)
      XV=X(1)
      YV=Y(1)
      BTV=BT(1)
      I=1
      XPL(I)=XV
      YPL(I)=YV
      DO 10 N=2,NQ
      XR=X(N)
      YR=Y(N)
      BTR=BT(N)
      DX=XR-XV
      DY=YR-YV
      DL=SQRT(DX*DX+DY*DY)
      DLT= ATAN2(DX,-DY)
      GA=SIN(BTV-DLT)/COS(BTV-DLT)
      GAS=SIN(DLT-BTR)/COS(DLT-BTR)
      IF(ABS(GA).LT..4.AND.ABS(GAS).LT..4)GO TO 4
      MSM=N-1
      NZT=NZPZ(2,0)
      WRITE(IDRU,2)NZT,GA,GAS,MSM,N
    2 FORMAT (A1,'WARNING - SUBROUTINE SMOOTH HAS SLOPES',F6.3,' AND'
     &,F6.3,' BETWEEN POINTS',I3,' AND',I3)
    4 ESS =ABS(GA-2.*GAS)
      ES=ABS(GAS-2.*GA)
      IF(ES.GT.ESS)ESS=ES
      NAB=INT(SQRT(DL*XZEH*ESS/HS))+1
      FNAB=FLOAT(NAB)
      DO 6 K=1,NAB
      U=FLOAT(K)/FNAB
      V=U*(1.-U)*(GA*(1.-U)+GAS*U)
      I=I+1
      XPL(I)=XV+U*DX-V*DY
      YPL(I)=YV+U*DY+V*DX
      IF(I.LT.121)GO TO 6
      CALL POLZUG(IS,XPL,YPL,121,.TRUE.,A)
      I=1
      XPL(1)=XPL(121)
      YPL(1)=YPL(121)
    6 CONTINUE
      XV=XR
      YV=YR
   10 BTV=BTR
      IF(I.GT.1)CALL POLZUG(IS,XPL,YPL,I,.TRUE.,A)
      RETURN
      END
 
      SUBROUTINE BPLOT(X,Y,N,M)
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
      COMMON/LINING/BROKL(12),NLINE(5),NPAR(5),J
      DIMENSION BF(8)
      IF(M.EQ.2)GO TO 20
      IF(M*ND.GE.2)GO TO 4
      IF(M.EQ.0.OR.N.EQ.1)CALL TPLOT(X,Y,N,0)
      IF(ND.LE.1)GO TO 10
      K=1
      SPL=BF(1)*.5
      GO TO 10
    4 DX=XZEH*(X-XV)
      DY=YZEH*(Y-YV)
      DS=SQRT(DX*DX+DY*DY)
    6 SPT=SPL
      IF(SPL.GT.DS)SPT=DS
      XE=XV+SPT*DX/(DS*XZEH)
      YE=YV+SPT*DY/(DS*YZEH)
      NPEN=(K-2*(K/2))*N
      IF(NPEN.NE.0.OR.SPL.LE.DS) CALL TPLOT(XE,YE,NPEN,0)
      IF(SPT.EQ.DS)GO TO 8
      K=K+1
      IF(K.GT.ND)K=1
      SPL=SPL+BF(K)
      GO TO 6
    8 SPL=SPL-DS
   10 XV=X
      YV=Y
      RETURN
   20 ND=NPAR(J)
      IF(ND.LT.2)RETURN
      NAN=NLINE(J)
      NEN=NAN+ND-1
      SB=0.
      DO 22 K=NAN,NEN
   22 SB=SB+BROKL(K)
      AB=AINT(X/SB)+1.
      DO 24 K=1,ND
      KS=K+NAN-1
   24 BF(K)=X*BROKL(KS)/(AB*SB)
      RETURN
      END
 
      SUBROUTINE POLZUG(IST,R,S,J,ALG,B)
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
      DIMENSION R(J),S(J)
      LOGICAL B,ALG
      EXTERNAL B
      DATAX,Y/0.,0./
      IF(J.LT.2)RETURN
      IF(ALG)GO TO 4
      PTL=0.
      DO 2 K=2,J
      DX=XZEH*(R(K)-R(K-1))
      DY=YZEH*(S(K)-S(K-1))
    2 PTL=PTL+SQRT(DX*DX+DY*DY)
      CALL BPLOT(PTL,0.,0,2)
    4 MAN=0
      NP=1
      NPD=1
      NEND=J
      IF(XZEH*ABS(R(1)-X)+YZEH*ABS(S(1)-Y).LE.XZEH*ABS(R(J)-X)+YZEH*ABS
     1 (S(J)-Y))GO TO 10
      NP=J
      NPD=-1
      NEND=1
   10 X=R(NP)
      Y=S(NP)
      NPEN=0
      IF(B(X,Y))NPEN=1
      IF(MAN.NE.0)GO TO 12
      MAN=1
      IF(ALG)CALL TPLOT(X,Y,0,0)
      IF(.NOT.ALG)CALL BPLOT(X,Y,0,0)
      GO TO 19
   12 IF(NPEV.EQ.NPEN)GO TO 18
      X1=X
      Y1=Y
      DO 16 K=1,7
      XZ=.5*(X1+XV)
      YZ=.5*(Y1+YV)
      NZ=0
      IF(B(XZ,YZ))NZ=1
      IF(NZ.NE.NPEV)GO TO 14
      XV=XZ
      YV=YZ
      GO TO 16
   14 X1=XZ
      Y1=YZ
   16 CONTINUE
      IF(ALG)CALL TPLOT(XZ,YZ,NPEV,0)
      IF(.NOT.ALG)CALL BPLOT(XZ,YZ,NPEV,1)
   18 IF(NPEN.EQ.0)GO TO 19
      IF(ALG)CALL TPLOT(X,Y,NPEN,0)
      IF(.NOT.ALG)CALL BPLOT(X,Y,NPEN,1)
   19 IF(NP.EQ.NEND)RETURN
      XV=X
      YV=Y
      NPEV=NPEN
      NP=NP+NPD
      GO TO 10
      END
 
      LOGICAL FUNCTION TRUE(X,Y)
      TRUE = .TRUE.
      RETURN
      END
 
      SUBROUTINE ACHS(M,UA,U1,U2,SA,SE,DS,DS2,A)
      DIMENSION X(3),Y(3)
      LOGICAL A
      EXTERNAL A
      MXY=2*(M/2)-M
      DS3=DS2
      DS1=DS
      Y(1)=UA
      Y(2)=UA
      XS=DS1*AINT(1.00001*SA/DS1)
      IF(SA.LT.0.)XS=XS-DS1
      X(1)=XS
      IF(M.LE.2) GO TO 3
      X(1)=ALOG10(X(1))
      DS3=1.
    1 XS=XS+DS1
    3 X(2)=XS
      IF(M.GT.2)X(2)=ALOG10(XS)
      X(3)=X(2)
      Y(3)=U1
      IF(ABS(DS3*AINT(X(3)*1.0001/DS3)-X(3)).GT..0001)GO TO 2
      Y(3)=U2
      IF(M.GT.2)DS1=10.*DS1
    2 IF(MXY.EQ.0)CALL POLZUG(1,Y,X,3,.TRUE.,A)
      IF(MXY.NE.0)CALL POLZUG(1,X,Y,3,.TRUE.,A)
      IF(XS.GE.SE-.0001)RETURN
      X(1)=X(2)
      GO TO 1
      END
 
      CHARACTER*2 FUNCTION NZPZ(LL,M)
C   FUNCTION - LINE COUNTING
      CHARACTER*2  IT(4)
      DATA IT/'+',' ','0','1'/,NZEIZA/100/
      L=LL
      NZEIZA=NZEIZA+L
      IF(L.GE.3) GO TO 1
      IF(M+NZEIZA.GT.60)GO TO 1
      GO TO 2
    1 L=3
      NZEIZA=1
    2 NZPZ=IT(L+1)
      RETURN
      END
 
      SUBROUTINE GAUSS(A,B,N,M,EPS)
      DIMENSION A(N,N),B(N,M)
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      EPS = ABS(EPS)
      DO 3 J=1,N
      H = .0
      DO 4 I=J,N
      Z = ABS(A(I,J))
      IF(Z.LT.H) GOTO 4
      K = I
      H = Z
    4 CONTINUE
      IF(H.GT.EPS) GOTO 5
    6 FORMAT(38H SINGULARITY ALARM IN SUBROUTINE GAUSS)
      WRITE(IDRU,6)
      RETURN
    5 IF(K.EQ.J) GOTO 7
      DO 8 I=J,N
      H = A(J,I)
      A(J,I) = A(K,I)
    8 A(K,I) = H
      DO 1 I=1,M
      H = B(J,I)
      B(J,I) = B(K,I)
    1 B(K,I) = H
    7 DO 9 I=1,N
      IF(I.EQ.J) GOTO 9
      H = A(I,J)/A(J,J)
      DO 10 K=J,N
   10 A(I,K) = A(I,K)-A(J,K)*H
      DO 2 K=1,M
    2 B(I,K) = B(I,K)-H*B(J,K)
    9 CONTINUE
      H = 1./A(J,J)
      DO 11 I=J,N
   11 A(J,I) = A(J,I)*H
      DO 12 I=1,M
   12 B(J,I) = B(J,I)*H
    3 CONTINUE
      RETURN
      END
 
      SUBROUTINE CDCL(MCDCL,JR,ISTIFT)
      DIMENSION XMK(2),UX(4),VY(4),DUX(4),DVY(4)
      COMMON CW(5,2,14),SA(5,2,14),SU(5,2,14),CLP(14),CDP(14),PG(36),
     *PUFF(22),GAPS(669),IGAP(6),GAP(753),PGI(70),YMK(2)
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      COMMON /LINING/BROKL(12),NLINE(5),NPAR(5),J
      COMMON/EA/IDUY(4),FCT1,FCT2,FCT3,FCT4,FCT5
      LOGICAL PL,TRUE
      EXTERNAL TRUE
      DATA DUX/0.,.0087,-.0087,0./,DVY/1.,-.5,-.5,1./
      KA=2
      IF(MCDCL.GE.2)GO TO 2
      IPLS=0
      ALMIN=0.
      PL=ISTIFT.GE.5
      ALMAX=0.
      CMMIN=0.
      CMMAX=0.
      CLMAX=0.
      CLMIN=0.
      CDMIN=1.
      CDLIM=1.
      IF(PUFF(4).NE.0.)CDLIM=PUFF(4)/FCT5
      KA=1
      JRMX=JR
    2 IF(JR.GT.JRMX)JRMX=JR
      DO 14 K=KA,2
      DO 12 J=1,JR
      IPL=0
      IVI=0
      IF (NAI.GE.3) IVI=J
      DO 10 I=1,NAL
      SA1=SA(J,1,I)
      SA2=SA(J,2,I)
      IF(SA1+SA2.GT..65) GO TO 10
      CALL VISC (I,J,CL,CD,CMV,ACH)
      IF(CD.GT.CDLIM)GO TO 10
      ALI=ACH-ALN
      IF(K.GT.KA)GO TO 8
      CLMAX=AMAX1(CLMAX,CL)
      CLMIN=AMIN1(CLMIN,CL,-4.*CMV)
      IF(ALMAX.LT.ALI)ALMAX=ALI
      IF(ALMIN.GT.ALI)ALMIN=ALI
      IF(CMMIN.GT.CMV)CMMIN=CMV
      IF(CMMAX.LT.CMV)CMMAX=CMV
      CDMIN=AMIN1(CDMIN,CD)
      IF(K.EQ.1)GO TO 10
    8 IPL=IPL+1
      CLP(IPL)=CL
      CDP(IPL)=CD
      IWA=0
      IF(CW(J,1,I).LT.0.)IWA=1
      IF(CW(J,2,I).LT.0.)IWA=IWA+2
      IF(IWA.EQ.0)GO TO 9
      FUX=.02
      IF(IWA.EQ.2)GO TO 7
    5 DO 6 L=1,4
      UX(L)=CD+FUX*DUX(L)
    6 VY(L)=CL+FUX*DVY(L)
      CALL POLZUG(ISTIFT,UX,VY,4,.TRUE.,TRUE)
    7 FUX=-FUX
      IF(FUX.GT.0.)GO TO 9
      IF(IWA.NE.1)GO TO 5
    9 PG(IPL)=-4.*CMV
      PGI(IPL)=CDAX+.0005*ALI
      PGI(IPL+14)=CDAX-.01*SA1+.01
      PGI(IPL+28)=CDAX-.01*SA2+.01
      PGI(IPL+42)=CDAX-.01*SU(J,1,I)+.01
      PGI(IPL+56)=CDAX-.01*SU(J,2,I)+.01
   10 CONTINUE
      IF(K.LT.2)GO TO 12
      IPLS=IPLS+IPL
      CALL POLZUG(ISTIFT,CDP,CLP,IPL,.FALSE.,TRUE)
      DO 11 KC=1,5
      LOC=1+14*(KC-1)
   11 CALL POLZUG(ISTIFT,PGI(LOC),CLP,IPL,.FALSE.,TRUE)
      CALL POLZUG(ISTIFT,PGI,PG,IPL,.FALSE.,TRUE)
   12 CONTINUE
      IF(K.GE.2)GO TO 14
      CLMI=.1*AINT(1.00001*CLMIN/.1)-.3
      IF(CLMIN.LT.0.)CLMI=CLMI-.1
      CDMI=0.
      IF(CDMIN.GT..01)CDMI=RUND(CDMIN,200.)-.005
      CDAX=CDMI+.025
      CDAN=CDMI-.003
      CLMA=AMAX1(2.4,PUFF(2),CLMAX+.3)
      CDQ=CDAX+.013
      SCF=1.
      QUER=10000.*SCF*(CDQ-CDAN)
      HOCH=100.*SCF*(CLMA-CLMI)
      CALL DEFINE(PL,QUER,HOCH,CDAN,CDQ,CLMI,CLMA)
   14 CONTINUE
      IVI=0
      IF(MCDCL.EQ.1.OR.MCDCL.GE.3)RETURN
      IF(IPLS.EQ.0)GO TO 16
      CLMAX=RUND(CLMAX+.06,10.)
      CDQ=CDQ-.003
      CT1=CDMI-.0002
      CT2=CDMI-.0005
      CALL ACHS(2,CDMI,CT1,CT2,CLMIN,CLMAX,.1,.5,TRUE)
      XMK(1)=CDMI+.0005
      XMK(2)=CDMI+.004
      DO 13 J=1,JRMX
      YMK(1)=CLMAX-.1*FLOAT(J-1)
      YMK(2)=YMK(1)
   13 CALL POLZUG(ISTIFT,XMK,YMK,2,.FALSE.,TRUE)
      CALL ACHS(1,0.,-.02,-.05,CDMI,CDQ,.001,.005,TRUE)
      CT1=CDAX+.0002
      CT2=CDAX+.0005
      CALL ACHS(2,CDAX,CT1,CT2,CLMIN,CLMAX,.1,.5,TRUE)
      CT1=CDAX-.0002
      CT2=CDAX-.0005
      CT3=-4.*CMMIN
      CT4=-4.*CMMAX
      CALL ACHS(2,CDAX,CT1,CT2,CT4,CT3,.2,.4,TRUE)
      CT1=CDAX+.0005*(ALMIN-2.)
      CDQ=CDAX+.0005*(ALMAX+1.)
      CALL ACHS(1,0.,.02,.05,CT1,CDQ,.0005,.0025,TRUE)
   16 CALL GCLOSE
      RETURN
      END
 
      SUBROUTINE VISC (I,J,CL,CD,CM,ACH)
      COMMON CW(5,2,14),SA(5,2,14),SU(5,2,14),GAP(92),VCH,GAD(662),IG(6)
     1,DU,ETA
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      ALRC=ALV(I)
      D1=AMAX1(ALRC-ALN+DLT,0.)
      D2=AMIN1(ALRC-ALN-DLTU,0.)
      SA1=SA(J,1,I)
      SA2=SA(J,2,I)
      DCL=.5*(D1*SA1+D2*SA2)
      CL=.11*VCH*(ALRC-DCL)
      IF(FMACH.NE.0.)CL=(CRL(I)/ETA-.11*DCL)*VCH
      CD=ABS(CW(J,1,I))+ABS(CW(J,2,I))
      CMC=CML(I)
      ACH=ALRC
      IF (IVI.EQ.0) GO TO 3
      CALL LSQA (AVI,IVI,ALRC,CMC)
      CSL=CL+.11*VCH*DCL
      CALL LSQA (BVI,IVI,CSL,ACH)
    3 CM=CMC+.0275*DCL*(ABS(1.-SA1-SA2)**1.5)
      RETURN
      END
 
      SUBROUTINE GRP(NAX,RE,MU,JR,ISTIFT)
      CHARACTER*2 NZPZ,ITZ,IZT,KBL,KST,IZP,NNESE,NAMP,NUFF,LD
      CHARACTER*4 RETX,STXT,SFTX,CDLTX,D2TX,D2RT,ALTX,CPV
      COMMON CW(5,2,14),SA(5,2,14),SU(5,2,14),HP(32),RP(32),PUFF(22),
     *AGAM(6),X(121),Y(121),DS(122),GAP(299),IDU,KDU,NQ,LDU(3),
     *GAPS(382),BETA(121),GAPQ(8),GAMMA(242),AMAT(102,102)
      COMMON/BL/HVGL,D2I,UR,UK1,DSZ,WR,MT,MA,V,V1,HR,D2R,XA,XU,DCQ,USTR,
     * VSTR,UTR,HTR,D2TR
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      COMMON/CHARS/NAMP(12),CPV(2),ALTX(4,2),NNESE,NUFF(80)
      COMMON/TRIT/DLV,SUMP,XTRI(4),NU,ND,XSTPI(4),STHI(4)
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
      COMMON/SOLLC/ISOLL,JSOLL(5),CSOLL(5),CIST(5),TM(5)
      COMMON/SF/ALOS
      DIMENSION RE(5),MU(5),SFTX(2),XIT(121),YIT(121),BETI(121),
     *CAE(2),WRE(5),H(5),D2(5),CAD(5),SAR(5),SUR(5),CWD(5),DD(5),CMV(5),
     *CPTR(5),BBL(5),CD(5),LD(5),LR(5),ACHI(5),D2TX(6),D2RT(6),CDLTX(2),
     *REVG(5),REDR(5)
      LOGICAL TRUE,PL,RG1,ITIM
      EXTERNAL TRUE,RG1
      DATARETX,STXT/'R =',' S'/,SFTX,CDLTX/'UPPE','LOWE',' CL=',' CD='/
      DATA D2TX/' DEL','RDEL',' DEL','CD L','TRIT','CF L'/,D2RT/'TA2',
     * 'TA2','TA1','OC.','.D.','OC.'/,KBL,KST/' ','*'/,HBBL,BBLI/-1.6,
     *.958/,SLM/.5/
      MA=0
      V=0.
      V1=0.
      NAI=1
      PUFF(1)=0.
      IF (NAIT(5).LT.0) SLM=-.0001*FLOAT(NAIT(5))
      KDTX=INT(AGAM(3))-1
      MAG=INT(AGAM(4))
      NKR=NQ-1
      HABLC = 2.5
      DO 1 J=1,JR
      LR(J)=INT(RE(J)*1.E-3+.5)
    1 WRE(J)= SQRT(RE(J))
      NALA = 1
      NALE = IABS(NAX)
      IF(NAX.LT.0) NALA = NALE
      DO 42 IA = NALA, NALE
      NAF=NAIT(NAI)
      NAIF=NAF/100
      NAF=NAF-100*NAIF
      NDF=NAF/10-1
      MIM=NAF-10*(NDF+1)
      IF(MAG.EQ.0.OR.IA.NE.1)GO TO 3
      PL=ISTIFT.GE.5
      CALL DEFINE(PL,390.,200.,1.43,1.95,.4,4.4)
      CALL ACHS(4,1.46,1.457,1.67,10.,10000.,10.,1.,TRUE)
      CALL ACHS(1,1.,.96,.92,1.46,1.67,.01,.05,TRUE)
      CALL ACHS(4,1.71,1.707,1.92,10.,10000.,10.,1.,TRUE)
      CALL ACHS(1,1.,.96,.92,1.71,1.92,.01,.05,TRUE)
      HP(1)=1.51509
      HP(2)=1.51509
      HP(3)=1.67
      RP(1)=1.
      RP(2)=2.6656
      RP(3)=3.9034
      CALL POLZUG(1,HP,RP,3,.TRUE.,TRUE)
      DO 2 IP=1,3
    2 HP(IP)=HP(IP)+.25
      CALL POLZUG(1,HP,RP,3,.TRUE.,TRUE)
    3 MIT=0
      ITIM=.FALSE.
      KRE=1
      JRA=1
      JRE=JR
      IVI=0
    4 DO 39 KR=1,KRE
      IF (.NOT.ITIM) GO TO 5
      JRA=KR
      JRE=KR
      IVI=KR
    5 DO 6 KAL=1,NKR
      IF (VPR(KAL,IA).LE.-.1) GO TO 7
    6 CONTINUE
    7 KAU=KAL-1
      IF (VPR(KAU,IA).LT..1) KAU=KAU-1
      DO 39 JU=1,2
      ALOS=FLOAT(JU-1)
      IP=0
      ND = 2*JU -3
      NDSD=JU-1
      NEND=1+NKR*NDSD
      NU=KAU+NDSD*(KAL-KAU)
      NUB=NU
      NUNDSD = NU - NDSD
      DSR=DS(NUNDSD)*VPR(NU,IA)/(VPR(NU,IA)-VPR(NU-ND,IA))
      S=0.
      UK=0.
      DO 12 J=JRA,JRE
      CPTR(J)= .99
      H(J)=1.
   12 BBL(J)=.1
      IF(KDTX.LE.0) GO TO 26
      IZT=NZPZ(2-ND,IABS(NU-NEND)+2)
      IZP=IZT
      IF(IZT.NE.NNESE)GO TO 10
      ALWR=ALV(IA)-DARF*ALN
      WRITE(IDRU,8)IZT,NAMP,ALWR,(ALTX(J,ITIT2),J=1,4)
    8 FORMAT (A1,25HBOUNDARY LAYER   AIRFOIL ,12A1,10H   ALPHA =,F6.2,
     *11H DEG. REL. ,4A4)
      IZT=NZPZ(1,0)
   10 WRITE(IDRU,14)IZT,SFTX(JU),(RETX,LR(J),MU(J),J=JRA,JRE)
   14 FORMAT(A1,1X,A4,9HR SURFACE,3X,5(4X,A3,I6,8H000 MU =,I2))
      IF(IZP.NE.NNESE)GO TO 26
      IZT=NZPZ(1,0)
      WRITE(IDRU,22)IZT,(KBL,D2TX(KDTX),D2RT(KDTX),J=JRA,JRE)
   22 FORMAT(A1,6X,1HS,8X,2HU ,5(A1,8X,3HH32,4X,A4,A3))
      GO TO 26
   24 NUPP=NUP
      DSP=DSR
      NUP=NU
      NU=NU+ND
      UK=UK1
      NUNDSD = NU - NDSD
      DSR = DS(NUNDSD)
   26 UK1=ABS(VPR(NU,IA))
      S = S + DSR
      DO 27 J=JRA,JRE
      DSZ = DSR
      UR = UK
      HVGL=H(J)
      MT=MU(J)
      D2I=D2(J)
      WR=WRE(J)
      CALL GRS
      IF (IA.NE.NAIF) GO TO 25
      CALL H12B (HR,H12R,QTS)
      D1T=D2R*H12R
      D1U=D1T
      IF (IABS(NU-NUB).LT.3) GO TO 23
      D1P=D1I(NUP,J)
      IF (UK1.LE.UK.AND.D1T.LT.D1P) D1T=D1P
      D1PP=D1I(NUPP,J)
      CMB=((D1T-D1P)/DSR-(D1P-D1PP)/DSP)/(DSP+DSR)
      IF (ABS(CMB).LE.SLM) GO TO 23
      D1T=((DSP+DSR)*SIGN(SLM,CMB)+(D1P-D1PP)/DSP)*DSR+D1P
      ITZ=NZPZ(1,0)
      WRITE (IDRU,123) ITZ,CMB,SLM,UK1,D1U,D1T
  123 FORMAT (A1,16HCAMBER RED. FROM,F9.3,3H TO,F6.3,3H U=,F7.4,5H D1U=,
     *F8.6,5H D1C=,F8.6)
   23 D1I(NU,J)=D1T
   25 DD(J) = D2R
      RTH=UK1*D2R*RE(J)
      IF(KDTX.EQ.2)DD(J)=RTH*1.E-6
      IF(KDTX.LT.3)GO TO 28
      CALL CDCF(RTH,HR,CDR,CFR,H12R)
      DD(J)=D2R*H12R
      IF(KDTX.EQ.4)DD(J)=2.*D2R*(UK1**((H12R+5.)/2.))
      IF(KDTX.EQ.5)DD(J)=18.4*ABS(HR)-21.74-.36*FLOAT(MT-3)-ALOG(RTH)
      IF(KDTX.EQ.6)DD(J)=CFR
   28 IF(UK.NE.0.)GO TO 30
      SAR(J)=0.
      SUR(J)=0.
   30 IF(SAR(J).GE.S-DSR-.00001)SAR(J)=SAR(J)+XA
      IF(HVGL*HR.GE.0.)GO TO 33
      IF(J.EQ.MAG)CALL HRPLT(UTR,HTR,D2TR,RE(J),IP)
      CPTR(J)=1.-UTR*UTR
      HVGL=-1.51509
   33 SUR(J)= SUR(J)+XU
      IF((HVGL.GT.HBBL.AND.HR.LE.HBBL).AND.BBL(J).LE..1)BBL(J)=UK+
     1 (UK1-UK)*(HBBL-HVGL)/(HR-HVGL)
      H(J)=HR
      IF(J.EQ.MAG)CALL HRPLT(UK1,HR,D2R,RE(J),IP)
   27 D2(J)=D2R
      IF(KDTX.LE.0)GO TO 35
      IZT=NZPZ(1,0)
      WRITE(IDRU,32)IZT,S,UK1,(H(K),DD(K),K=JRA,JRE)
   32 FORMAT (A1,F9.5,F8.3,5(F13.4,F10.6))
   35 IF (NU.NE.NEND) GO TO 24
      IF(IP.GE.2)CALL POLZUG(1,HP,RP,IP,.TRUE.,RG1)
      IF(KDTX.NE.3)GO TO 37
      IZT=NZPZ(1,0)
      WRITE(IDRU,36)IZT,(KBL,CPTR(K),K=JRA,JRE)
   36 FORMAT (A1,17X,5(A1,5X,11HCP(TRANS) =,F6.2))
      IF (ITIM) GO TO 39
   37 DO 38 J=JRA,JRE
      CALL H12B(H(J),H12R,QTS)
      IF(H12R.GT.HABLC)H12R = HABLC
      IF(H(J).LT.0..AND.BBL(J).LE..1)BBL(J)=UK1
      BBF=2.
      BBTR=BBL(J)
      IF(BBTR*BBTR/(1.-CPTR(J)).LT.BBLI*BBLI)BBF=-2.
      CW(J,JU,IA)=(UK1**(2.5+.5*H12R))*D2(J)*BBF
      SA(J,JU,IA)= S - SAR(J)
   38 SU(J,JU,IA)= S - SUR(J)
   39 CONTINUE
      IF (IA.NE.NAIF) GO TO 42
      IF (MSPLI.EQ.0) CALL SPLITZ (X,Y,NQ,BETA)
      DO 43 LJ=1,JR
      DO 40 K=1,NQ
      IF (K.LE.KAU.OR.K.GE.KAL) D1A=D1I(K,LJ)
      IF (K.GT.KAU.AND.K.LT.KAL) D1A=.5*(D1I(KAU,LJ)+D1I(KAL,LJ))
      XIT(K)=X(K)-D1A*COS(BETA(K))
   40 YIT(K)=Y(K)-D1A*SIN(BETA(K))
      CALL SPLITZ (XIT,YIT,NQ,BETI)
      CALL PANEL (XIT,YIT,BETI,1,NKR,AMAT,GAMMA,CAE)
      IVI=LJ
      IF (NDF.GE.0) CALL DIAGR (1,NDF,0,IA,IA,XIT,YIT,BETI,NQ)
      IF(MIT+1.GE.MIM)CALL MOMENT(X,Y,NQ,IA,IA)
      CLIT=CRL(IA)
      ITZ=NZPZ(2,0)
      WRITE (IDRU,45) ITZ,ALV(IA),LR(LJ),CLIT
   45 FORMAT (A1,34HDISPLACEMENT ITERATION WITH ALPHA=,F6.2,
     *8HDEG., R=,I5,8H000, CL=,F6.2)
   43 CONTINUE
      KRE=JR
      ITIM=.TRUE.
      MIT=MIT+1
      IF (MIT.LT.MIM) GO TO 4
      NAI=NAI+1
      IVI=0
   42 CONTINUE
      I=0
      ITZ=NZPZ(2,4*(NALE-NALA+1)+2)
      IF(ITZ.NE.NNESE.AND.NAX.LT.0)GO TO 48
   44 WRITE(IDRU,46)ITZ,NAMP,ALN,(ALTX(J,ITIT2),J=1,4)
   46 FORMAT(A1,16HSUMMARY AIRFOIL ,12A1,8H ALPHA0=,F5.2,18H DEG., ALPHA
     * REL. ,4A4)
      ITZ=NZPZ(1,0)
      WRITE(IDRU,47)ITZ,FMACH,BBLI
   47 FORMAT(A1,5HMACH=,F5.3,33H  * INDICATES BUBBLE U RED. BELOW,F6.3)
      IF(XTRI(4).GE.0.)GO TO 74
      DO 70 J=1,4
      IF(XSTPI(J).EQ.0.)GO TO 70
      ITZ=NZPZ(1,0)
      JS=(J+1)/2
      WRITE(IDRU,72)ITZ,XSTPI(J),SFTX(JS),STHI(J)
   70 CONTINUE
   72 FORMAT(A1,10HSTEP AT X=,F6.4,1X,A4,5HR S. ,F7.4,5H HIGH)
   74 ITZ=NZPZ(2,0)
   48 WRITE(IDRU,49)ITZ,(RETX,LR(J),MU(J),J=1,JR)
   49 FORMAT (A1,5X,5(4X,A3,I6,9H000   MU=,I2))
      IF(I.NE.0) GO TO 51
      I=NALA
   51 ITZ=NZPZ(2,4)
      IF(ITZ.EQ.NNESE)GO TO 44
      ALWR=ALV(I)-DARF*ALN
      WRITE (IDRU,50) ITZ,ALWR
   50 FORMAT (A1,8H ALPHA =,F6.2,8H DEGREES)
      ITZ=NZPZ(1,0)
      WRITE (IDRU,101) ITZ,(J,STXT,J=1,JR)
  101 FORMAT (A1,4X,5(I5,A2,5H TURB,1X,5HS SEP,4X,2HCD))
      DO 52 K=1,2
      DO 53 J=1,JR
      CWPM=CW(J,K,I)
      LD(J)=KBL
      IF(CWPM.LT.0.) LD(J)=KST
   53 CD(J)=ABS(CWPM)
      ITZ=NZPZ(1,0)
   52 WRITE(IDRU,54)ITZ,SFTX(K),(SU(J,K,I),SA(J,K,I),CD(J),LD(J),J=1,JR)
   54 FORMAT(A1,1X,A4,1HR,5(F9.4,F7.4,F7.4,A1))
      DO 56 J = 1,JR
      IVI=0
      IF (NAI.GE.3) IVI=J
      CALL VISC(I,J,CADZ,CWDZ,CMV(J),ACHI(J))
      IF(ISOLL*(I-1).LE.0)GO TO 55
      DO 110 IS=1,ISOLL
      IF(JSOLL(IS).NE.J)GO TO 110
      CSO=CSOLL(IS)
      CSP=ABS(CSO)
      DCA=CADZ-CAD(J)
      DRE=RE(J)-REVG(J)
      STG=(CWDZ-CWD(J))/DCA
      IF(CSO.LE.0.)GO TO 104
      IF((CADZ-CSO)*(CAD(J)-CSO).GT.0.)GO TO 110
      CIST(IS)=CWDZ-STG*(CADZ-CSO)
      CALOK=CSO
      GO TO 108
  104 IF((CWDZ-CSP)*(CWD(J)-CSP).GT.0.)GO TO 110
      CALOK=CADZ-(CWDZ-CSP)/STG
      CIST(IS)=CALOK
  108 RED=RE(J)
      IF(ABS(DCA).GT..0001)RED=RED-(CADZ-CALOK)*DRE/DCA
      REDR(IS)=RED
  110 CONTINUE
   55 CAD(J)=CADZ
      REVG(J)=RE(J)
   56 CWD(J)=CWDZ
      ITZ=NZPZ(1,0)
      WRITE (IDRU,58) ITZ,(KBL,CAD(J),CWD(J),J=1,JR)
   58 FORMAT (A1,6H TOTAL,A1,2X,3HCL=,F6.3,4H CD=,F7.4,
     *4(A1,3X,3HCL=,F6.3,4H CD=,F7.4))
      ITZ=NZPZ(1,0)
      WRITE (IDRU,102) ITZ,(KBL,CMV(J),ACHI(J),J=1,JR)
  102 FORMAT (A1,5X,5(A1,3HCM=,F7.4,4H AC=,F8.4,1X))
      I=I+1
      IF (I.LE.NALE) GO TO 51
      IVI=0
      IF(NALE.NE.NAL)GO TO 64
      IF(MAG.NE.0)CALL GCLOSE
      IF(ISOLL.EQ.0)GO TO 64
      ITZ=NZPZ(2,ISOLL-1)
      DO 63 IS=1,ISOLL
      IDC=1
      CSL=CSOLL(IS)
      IF(CSL.LT.0.)IDC=2
      CSL=ABS(CSL)
      JSL=JSOLL(IS)
      WRITE(IDRU,62)ITZ,RETX,REDR(IS),MU(JSL),CDLTX(IDC),CSL,
     * CDLTX(3-IDC),CIST(IS)
   62 FORMAT(A1,A3,F9.0,5H  MU=,I2,2X,A4,F5.4,2X,A4,F6.5)
      IF(IS.NE.ISOLL)ITZ=NZPZ(1,0)
   63 CONTINUE
   64 RETURN
      END
 
      SUBROUTINE HRPLT(U,H,D2,RE,IP)
      COMMON/SF/ALOS
      COMMON GAP(420),HP(32),RP(32)
      LOGICAL RG1
      EXTERNAL RG1
      IP=IP+1
    1 RP(IP)=ALOG10(U*D2*RE)
      HP(IP)=ABS(H)+.25*ALOS
      IF(IP.LT.32)RETURN
      CALL POLZUG(1,HP,RP,IP,.TRUE.,RG1)
      IP=1
      GO TO 1
      END
 
      LOGICAL FUNCTION RG1(X,Y)
      COMMON/SF/ALOS
      RG1=Y.GE.1..AND.X.LE.1.67+.25*ALOS
      RETURN
      END
 
      SUBROUTINE UMP(U,D2,H,FUM)
      COMMON P(512),X(121),Y(121)
      COMMON/TRIT/DLV,SUMP,XTRI(4),NU,ND,XSTPI(4),STHI(4)
      COMMON/BL/DUM(5),WRE,M,MD,DU(7),US,DUMY(4)
      COMMON/JGR/TFAC
      FUM=-18.4
      IF(M.LE.0)GO TO 9
      IF(M.GE.3)GO TO 4
      MXT=2*M-1+(ND+1)/2
      N=NU-ND
      FUM=X(N)+SUMP*(X(NU)-X(N))/DLV -XTRI(MXT)
      GO TO 9
    4 FUM=ALOG(WRE*WRE*D2*U)+21.74+TFAC*FLOAT(M-3)-18.4*H
    9 RETURN
      END
 
      SUBROUTINE CDCF(  RET,H,CD,CF,H12)
      COMMON /GRZK/CDK,AA(7),BB(7)
      CALL H12B(H,H12,EPST)
      IF(H)1, 3,2
    1 RZ = ALOG((H12-1.)*RET)
      CD = CDK*EXP(-.166692*RZ)
      CF = .045716*EXP(-1.26*H12 -.232*RZ)
      GO TO 3
    2 CD = ((H*6.8377961- 20.521103)*H + 15.707952)/RET
      CF = EPST/RET
    3 RETURN
      END
 
      SUBROUTINE GRUP(H,D2,U,Z,DZ,DD2,V)
      COMMON /GRZK/CDK,AA(7),BB(7)
      COMMON/BL/DUM(4),DL,WRE,MD,MA,DU(7),US,DUMY(4)
      Z = D2*ABS(H)
      RET = WRE*WRE*U*D2
      CALL CDCF(   RET,H,CD,CF,H12)
      IF(MA)1,1,2
    1 V = 0.
      GO TO 13
    2 GO TO(13,13,13,6,6,5,5,3),MA
    3 IF(H)4,1,1
    4 V = 25.*(H+1.98)*D2*US
      GO TO 12
    5 IF(H)6,1,1
    6 B = BB(MA)
      PSI = AA(MA)
      IF(B.NE.0.)PSI=B*ALOG(RET)+PSI
      IF(PSI.GE.1.52.AND.PSI.LE.1.99)GO TO 11
      B=0.
      IF(PSI.LT.1.52)PSI=1.52
      IF(PSI.GT.1.99)PSI=1.99
   11 HZ = SIGN(PSI,H)
      CALL CDCF(   RET,HZ,CDS,CFS,H12S)
      V=(U*(CDS-(PSI+B)*CFS)+D2*US*(B-PSI+H12*(B+PSI)))/(B+ABS(H)-1.)
   12 IF(V)13,1,1
   13 VDU =V/U
      USU =US/U
      DD2 = (CF-(2.+H12)*USU*D2+VDU)*DL
      DZ  = (CD - 3.*Z*USU + VDU)*DL
   14 RETURN
      END
 
      SUBROUTINE H12B(H,H12,EPST)
      IF(H)4,5 ,1
    1 IF(H-1.57258)2,3,3
    2 H12 =(SQRT(H-1.515090))*((-227.18220*H+724.55916)*H-583.60182)
     1+4.0292200
      EPST=  ((-.03172850655*H12+.3915405523)*H12-1.686094798)*H12
     1+2.512588652
      GO TO 5
    3 EPST =  (H*2.221687229-4.226252829)*H+1.372390703
      H12 = (25.71578574*H-89.58214201)*H + 79.87084472
      GO TO 5
    4 H12 = (H-1.36364)/(H*4.36364 + 5.36364)
    5 RETURN
      END
 
      SUBROUTINE GRS
      CHARACTER*2 NZPZ,ITZ
      COMMON GAP(512),XPROF(121)
      COMMON/BL/HVGL,D2,UK,UK1,DL,WRE,MU,MA,V,V1,HR,D2R,XA,XU,DCQ,USTR,
     $ VSTR,UTR,HTR,D2TR
      COMMON/TRIT/DLV,SUMP,XTRI(4),NU,ND,XSTPI(4),STHI(4)
      DATA EAP,EUM,HE/.000005,.0001,-1.0/
      BIT=0.
      H=HVGL
      IF(MA)3,101,3
  101 V1 = 0.
      V = 0.
      IF(HE.LE.0..OR.UK.LE.0.)GO TO 3
    1 IF(ABS(UK-UKV)+ABS(UK1-UK1V)+ABS(DL-DLV)+ABS(H-HV)-.1E-6)2,3,3
    2 IF(ABS(D2*WRE-D2V*WREV).GE..1E-6) GO TO 3
      BIT = 1.
      D2E = D2E*WREV/WRE
    3 D2V=D2
      HV = H
      UKV= UK
      UK1V = UK1
      DLV = DL
      WREV = WRE
      DCQ = 0.
      XA = DL
      XU = DL
      VV = V
      IF(DL)4,4,5
    4 HE=H
      D2E= D2
      GO TO 50
    5 USTR =(UK1-UK)/DL
      IF(MA.LT.4)VSTR =(V1-V)/DL
      IF(UK)6,7,6
    6 IF((UK1-UK)/UK - 1.)8,8,7
    7 D2E = .290043/(WRE*SQRT(USTR))
      HE = 1.619977
      GO TO 50
    8 IF(D2)9,9,10
    9 D2E =(.664108/WRE)*SQRT(2.*DL/(UK1+UK))
      HE = 1.572584
      GO TO 50
   10 X = 0.
      SUMP=X
      ISTAB = 0
      IF(H.LT.0.)XU = 0.
      IF(BIT)13,13,11
   11 CALL UMP(UK,D2,H,FUM)
      GO TO 40
   13 IF(X +DL -DLV)12,12,19
   12 XS = X
      UK = UKV +  XS*USTR
      VG= VV + VSTR*XS
      IF(H)14,14,16
   14 HAP = 1.46
      IF(HAP+EAP.LE.-H.OR.UK1.GE.UK)GO TO 20
      XA=X
      CALL H12B(H,H12,EPST)
      D2E = D2*(UK/UK1)**((5.+H12)*.5)
      HE = H
      GO TO 50
   16 HAP = 1.515095
      SUMP=X
      IF(HAP+EAP-H)17,18,18
   17 CALL UMP(UK,D2,H,FUM)
      IF(FUM+EUM)20,18,18
   18 H = -H
      HTR=-H
      UTR=UK
      D2TR=D2
      XU = X
      ISTAB = 0
   19 DL = DLV - X
      GO TO 12
   20 CALL GRUP(H,D2,UK,Z,DZ,DD2,VG)
      ESP = .002
      IF(MA-3)22,22,21
   21 ESP = .001
      IF(X .EQ.0.)V = VG
   22 XS = XS + .5*DL
      D2M = D2 + .5*DD2
      ZM = Z + .5*DZ
      UM = UKV +USTR*XS
      ISG = 1
      IF(D2M)25,25,23
   23 ISG = 2
      HM = ZM/D2M
      IF(HM - 2.)30,25,25
   25 ISGV = ISG
      IF(ISTAB.GE.12)GO TO 50
   26 ISTAB = ISTAB +1
      DL = .5*DL
      GO TO 13
   30 IF(HM - HAP+EAP)31,32,32
   31 DL = .5*DL*(ABS(H)-HAP)/(ABS(H)-HM)
      GO TO 13
   32 IF(H.LT.0.)HM = -HM
      IF(MA.LT.4)VM= VV+ XS*VSTR
      CALL GRUP(HM,D2M,UM,ZM,DZM,DD2M,VM)
      ISG = 3
      D2E = D2 +DD2M
      IF(D2E)25,25,33
   33 HE= (Z+DZM)/D2E
      ISG = 4
      IF(HE-2.)34,25,25
   34 HDIFF = HE-ABS(H)
      ISG = 5
      IF(ABS(HDIFF)-.01)35,35,25
   35 HS = ABS(ABS(H)-2.*ABS(HM)+HE)
      ISG = 6
      IF(HS-ESP)36,36,25
   36 IF(HE-HAP+EAP)37,38,38
   37 DL = DL*(ABS(H)-HAP)/(ABS(H)-HE)
      GO TO 13
   38 IF(H)39,39,40
   39 HE = -HE
      GO TO 42
   40 UE = UK + USTR*DL
      SUMP=X+DL
      CALL UMP(UE,D2E,HE,FUME)
      IF(FUME-EUM)42,42,41
   41 DL = DL*FUM/(FUM-FUME)
      GO TO 13
   42 DCQ = DCQ + DL*VM
      X = X + DL
      IF(X -DLV)47,50,50
   47 H = HE
      D2 = D2E
      GO TO(43,13,43,45,13,43),ISGV
   43 IF(HS-.1*ESP)44,13,13
   44 DL = 2.*DL
      ISTAB =ISTAB-1
      GO TO 13
   45 IF(HDIFF)44,13,13
   50 HR = HE
      D2R = D2E
      IF(XTRI(4).GE.0.)RETURN
      XEN=XPROF(NU)
      NXTR=NU-ND
      XAN=XPROF(NXTR)
      DO 52 IST=1,2
      KAST=1+ND+IST
      XSTF=100.*ABS(XTRI(KAST))
      XSF=.01*AINT(XSTF)
      IF(XSF.EQ.0.)GO TO 52
      IF(XEN.LT.XSF.OR.XAN.GE.XSF)GO TO 52
      STH=.01*(XSTF-100.*XSF)
      RET=D2R*WRE*WRE*UK1
      CALL CDCF(RET,HR,CD,CF,H12)
      WCF=SQRT(CF)
      UH=0.
      IF(STH.GT.0.)UH=WCF*(2.17*ALOG(WCF*UK1*WRE*WRE*STH)+6.5)
      DD2S=.15*STH*UH
      D2R=D2R+DD2S
      IF(HR.LT.0.)HR=HR-(1.+HR)*DD2S/D2R
      IF(HR.LT.0.)GO TO 53
      HTR=HR
      HR=-HR
      UTR=UK1
      D2TR=D2
   53 ITZ=NZPZ(1,0)
      WRITE(6,54)ITZ,HR,HE,D2R,D2E,CF,UH,UK1
   54 FORMAT(A1,4HH32=,F7.4,1H/,F7.4,4H D2=,F8.6,1H/,F8.6,4H CF=,
     " F8.6,4H UH=,F7.5,3H U=,F6.4)
      XSTPI(KAST)=XEN
      STHI(KAST)=STH
   52 CONTINUE
      RETURN
      END
 
      FUNCTION RUND(A,B)
      RUND = (AINT(A*B+SIGN(.5,A)))/B
      RETURN
      END
 
      FUNCTION COSG(A)
      COSG = COS(A*.0174532925199)
      RETURN
      END
 
      FUNCTION SING(A)
      SING = SIN(A*.0174532925199)
      RETURN
      END
 
      FUNCTION CSLG(A,B)
      CSLG = ALOG(ABS(SING(A-B)))
      RETURN
      END
 
      SUBROUTINE EDRAW(WC,WS,WL,DK,DM,FL,AG,MA)
C   CALL EDRAW(WC,WS,WL,DRAK(J),DRAM(J),FLA(J),ABGR,MKP)
C   WHEN MKP = 0, DK = KAPPA; OTHERWISE, DK = K.
      COSP = COSG(AG*FL)
      FK= DK
      IF(MA)2,1,2
    1 FK= FK*(1.-COSP)/(1.+COSP)
    2 SINP = SING(AG*FL)
      WL = -DM*ALOG(1.+FK)
      IF(FL.EQ.0.) FK = 1.
      BETA =(COSP-1.)/FK + COSP
      BQM1 = BETA**2 - 1.
      WUBEQ= SQRT(ABS(BQM1))
      U= (1.+BETA)*SINP/(1.+COSP)
      IF(BQM1)3,5,4
    3 WF = ALOG(ABS((WUBEQ+U)/(WUBEQ-U)))
      GO TO 6
    4 WF = 2.* ATAN(U/WUBEQ)
      GO TO 6
    5 WF = 0.
    6 WC =(WUBEQ*WF - SINP - BETA*FL*AG*1.745329E-2)*DM
      WS = (COSP-1.)*(1.-(1./FK + 1.)*ALOG(1.+FK))*DM
      RETURN
      END
 
      SUBROUTINE TRAPRO
      CHARACTER*2 NZPZ,NZT,IZT,NAMP,NNESE,NUFF
      CHARACTER*4 ALTX,CPV
      DIMENSION FLS(2),FLA(2),DRAK(2),DRAM(2),AC(4,3),D(3),
     1WSI(2),WCI(2),FINT(3),A(4),HK(2),R(3),FKERN(30)
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      COMMON P1(121),P(121),XP(121),YP(121),PUFF(22),AGAM(6),X(121),
     1Y(121),DS(122),VF(121),ARG(121),ANI(28),ALFR(29),IZZ,KFU,NQ,NUPRO,
     2JAB,JST,CM,ETA,ABFA,PI,BOGEN,DARG,PURES(13),GAP(450),ALFA(29)
      COMMON/CHARS/NAMP(12),CPV(2),ALTX(4,2),NNESE,NUFF(80)
      DATA ABSZ/0./
      CALL WANDEL(NUPRO,NAMP,12,5)
      ALFR(JAB+1)=0.
      ABZT=ANI(JAB)
      IF(ABS(ABZT-ABSZ).LT..1) GO TO 14
      IB=INT(.25*ABZT+.1)
      MQ=2*IB
      NKR=2*MQ
      ABSZ=FLOAT(NKR)
      ABGR=360./ABSZ
      HABGR=.5*ABGR
      DO 8 M=1,IB
      ARI=FLOAT(MQ+1-2*M)*HABGR
    8 FKERN(M)=ABGR*COSG(ARI)/(SING(ARI)*PI)
   14 MAGAM=INT(AGAM(2))
      NQ=NKR+1
      IF(MAGAM.EQ.0) GO TO 22
      NZT=NZPZ(3,0)
      WRITE(IDRU,82)NZT
   22 DO 23 I=1,29
   23 ALFA(I)=ALFR(I)
      I=1
      J=1
   24 FLS(J)= PURES(I)*ABFA
      CALL EDRAW(WC,WS,WL,.6,-1.,FLS(J),ABGR,1)
      CALL EDRAW(WCI(J),WSI(J),WLI,-.6,-1.,FLS(J),ABGR,1)
      WCI(J)= WCI(J)+WC
      WSI(J)= WSI(J)+WS
      WLI = WLI+WL
      FLA(J)= PURES(I+1) * ABFA
      IF(FLA(J).GT.0.)GO TO 26
      DRAKS=0.
      DRAMS=1.
      GOTO 34
   26 WI = COSG(ABGR*FLA(J))
      IFR=INT(PURES(I+2)+.25)
      PU3=FCT1*PURES(I+3)
      PU4=FCT1*PURES(I+4)
      IF(IFR-1)27,30,29
   27 DRAKS=PU3
      DRAMS=PU4
      GO TO 34
   29 DRAKS=(PU4**(-1./PU3)-1.)*(1.+WI)/(1.-WI)
      IF(IFR.EQ.3)DRAKS=.5*PU4*(1.+WI)/PU3
      DRAMS=PU3
      GO TO 34
   30 AA=.5*PU3*(1.-WI)
      WILN=-ALOG(PU4)
      RS=AA/WILN-1.
      U=.5/RS+2.727/(RS+7.)
      FU=.5
      IF(ABS(RS).GT..00501664)GO TO 31
      PU3=RUND(100.*WILN,1000.)
      GO TO 29
   31 EHRU=EXP(1./U)
      FUV=FU
      FU=U*(EHRU-1.)-1.-RS
      U=U-FU/(EHRU*(1.-1./U)-1.)
      IF(ABS(FU).GT..01.OR.ABS(FU).LT.ABS(FUV)-.5E-9)GO TO 31
      FM=U*WILN
      DRAMS=RUND(FM,1000.)
      DRAKS=.5*PU3*(WI+1.)/FM
   34 DRAM(J)=DRAMS
      DRAK(J)=RUND(DRAKS,1000.)
      I=I+5
      J= J+1
      IF(J-3)24,38,38
   38 MER = 0
      WSI(2)= -WSI(2)
      D(1) = WLI *(WSI(2)+WSI(1))
      D(2) =-WLI *(WCI(2)+WCI(1))
      D(3) = WCI(1)*WSI(2)-WCI(2)*WSI(1)
      ITMOD=INT(PURES(11))
      RUF=100.
      IF(ITMOD.GE.4.AND.ITMOD.LE.6)RUF=1000.
      ITMR=ITMOD
      SHKS = FCT1*PURES(12)
      HKST=FCT1*ABS(PURES(13))
   35 DO 36 J=1,3
   36 AC(1,J)= 0.
      ALIV = 0.
      SINAI = 0.
      COSAI = 1.
      FNI = 0.
      J=1
   37 CSAIP = COSG(2.*ALFA(J))
      SNAIP = SING(2.*ALFA(J))
      IF(J-JST-1)40,39,40
   39 AC(2,1)= SINAI
      AC(2,2)= -1.-COSAI
      AC(2,3)= -1.
      AC(3,1)= -SNAIP
      AC(3,2)= 1.+CSAIP
      AC(3,3)= 1.
      AC(4,1)= COSAI-CSAIP
      AC(4,2)= SINAI-SNAIP
      AC(4,3)= 0.
      ALIS = ALIV
      ALISP = ALFA(J)
      GOTO 41
   40 FII = CSLG(HABGR*FNI-90.,ALIV)
      FIIP= CSLG(HABGR*FNI-90.,ALFA(J))
      PB=FNI*HABGR*BOGEN
      AC(1,1)=-FIIP*SNAIP+FII*SINAI+(COSAI-CSAIP)*PB +AC(1,1)
      AC(1,2)=-FII*(1.+COSAI)+FIIP*(1.+CSAIP)+(SINAI-SNAIP)*PB+AC(1,2)
      AC(1,3)= FIIP - FII + AC(1,3)
   41 IF(J-JAB-1)42,43,43
   42 ALIV =ALFA(J)
      SINAI=SNAIP
      COSAI=CSAIP
      FNI = ANI(J)
      J=J+1
      GO TO 37
   43 DO 47 J=1,2
      IF(FLA(J)) 47,47,49
   49 CALL EDRAW(WC,WS,WL,DRAK(J),DRAM(J),FLA(J),ABGR,0)
      AC(1,1)= WC+ AC(1,1)
      IF(J-2)45,44,45
   44 WS = -WS
      WL =- WL
   45 AC(1,2) = WS +AC(1,2)
      AC(1,3) =-WL +AC(1,3)
   47 CONTINUE
      DO 52 J=1,4
      A(J) = 0.
      DO 52 I=1,3
   52 A(J) = A(J)+D(I)*AC(J,I)
      A1=A(1)+.5*PI*A(4)
      A2=A(2)
      A3=A(3)
      A4=A(4)
      IF(ALIS.LE.ALISP)GO TO 65
C   SOLUTION OF TRANSCENDENTAL EQUATION
      FP=.5
      PHISH =     .5 *(ALIS+ALISP)
   60 CSLI = CSLG(PHISH,ALIS)
      CSLIP= CSLG(PHISH,ALISP)
      FV=FP
      FP=A1+A2*CSLI+A3*CSLIP+A4*BOGEN*PHISH
      IF(FP.LT..01.AND.ABS(FP).GE.ABS(FV)-.5E-9)GO TO 66
      IPRB=0
      PDIF=-FP/(A2/(PHISH-ALIS)+A3/(PHISH-ALISP)+A4*BOGEN)
   63 PHISH=PHISH+PDIF
      IF(PHISH.LT.ALIS.AND.PHISH.GT.ALISP)GO TO 60
      IPRB=IPRB+1
      PDIF=-.5*PDIF
      IZT=NZPZ(2,0)
      WRITE(IDRU,62)IZT,PDIF
   62 FORMAT(A1,30HSTEP REDUCTION IN LOTRA, PDIF=,F9.5)
      IF(IPRB.GT.1)PDIF=-PDIF
      IF(IPRB.LE.3)GO TO 63
   65 WRITE(IDRU,64)ALIS,ALISP,PHISH
   64 FORMAT(45H0WRONG TRA1-, TRA2-CARDS SUPPOSED, ALPHA(IL)=,F6.2,
     * 14H, ALPHA(IL+1)=,F6.2,8H, PHISH=,F9.4)
      STOP
   66 ANI(JST) = (PHISH+90.)/HABGR
   70 DO 71 I=1,3
   71 FINT(I)=AC(1,I)+AC(2,I)*CSLI+AC(3,I)*CSLIP+AC(4,I)*BOGEN*(PHISH+
     F90.)
   69 HK(1)=(FINT(1)*WLI-FINT(3)*WCI(2))/D(2)
      HK(2)=(FINT(1)*WLI+FINT(3)*WCI(1))/D(2)
      HKS = HK(1)+HK(2)
      IF(ITMOD.EQ.0.OR.ABS(HKS-SHKS).LT.HKST) GO TO 74
      IF(MAGAM.LT.2.AND.MAGAM-MER.NE.1) GO TO 100
      GO TO 76
   74 ITMOD =0
      IF(MAGAM.EQ.0) GO TO 300
   76 NZT=NZPZ(2,JAB+4)
      WRITE(IDRU,77)NZT,NUPRO,MER,ITMR
   77 FORMAT (A1,42HTRANSCENDENTAL EQUATION RESULTS   AIRFOIL ,I4,
     *12H   ITERATION,I2,8H   MODE ,I1)
      NZT=NZPZ(1,0)
      WRITE(IDRU,78)NZT
   78 FORMAT (A1,69H   NU   ALPHA*  OMEGA'  OMEGA     K       MU     K H
     *   LAMBDA LAMBDA*)
      JH= 1
      ANIV=0.
      DO 85 JN=1,JAB
      NZT=NZPZ(1,0)
      ANID=ANI(JN)
      ALFD=ALFA(JN)
      IF(JN.NE.1.AND.JN.NE.JAB) GO TO 83
      X1 = .5*(1.+ COSG(FLA(JH)*ABGR))
      WHK  = (1.+DRAK(JH)*(1.-X1)/X1)**(-DRAM(JH))
      WSTR= DRAM(JH)*DRAK(JH)/X1
      WRITE(IDRU,82)NZT,ANID,ALFD,WSTR,WHK,DRAK(JH),DRAM(JH),HK(J
     1H),FLA(JH),FLS(JH)
   82 FORMAT(A1,F7.3,F7.2,F8.3,F7.3,2F8.3,F9.6,2F7.2)
      JH=2
      GO TO 84
   83 WRITE(IDRU,82)NZT,ANID,ALFD
   84 IF(ANID.LE.ANIV)WRITE(IDRU,86)JN
   85 ANIV = ANID
   86 FORMAT(1H+,72X,13HWARNING, NUE(,I2,16H) NOT INCREASING)
      IF(ITMOD.EQ.0) GO TO 300
  100 IF(MER)103,102,103
  102 DAL = .1
      GO TO 104
  103 IF(HKS-HKSV.EQ.0.)GO TO 74
      DAL = (SHKS-HKS)*DAL/(HKS-HKSV)
      DALD=DAL
      IF(ITP.EQ.0)DAL=RUND(DAL,RUF)
      IF(MAGAM.EQ.0.)GO TO 1004
      NZT=NZPZ(2-(MER+20)/22,0)
      WRITE(IDRU,1003)NZT,MER,HKS,DALD,DAL
 1003 FORMAT (A1,9HITERATION,I2,3X,5HK S =,F9.6,3X,7HDELTA =,F12.8,
     *3X,9HROUNDED =,F7.3)
 1004 IF(DAL.EQ.0.)GO TO 74
      IF(MER.GE.3.AND.ABS(DALV).LE.ABS(DAL))GO TO 74
  104 DALV=DAL
      IF(ITMOD.GE.4)GO TO 113
      DO 111 J=1,JAB
      IF(ITMOD.NE.2.AND.J.LE.JST) ALFA(J)=ALFA(J)+DAL
      IF(ITMOD.NE.1.AND.J.GT.JST) ALFA(J)=ALFA(J)-DAL
  111 CONTINUE
      GO TO 112
  113 IF(ITMOD.GE.7)GO TO 114
      IF(ITMOD.NE.5)DRAK(1)=DRAK(1)+DAL
      IF(ITMOD.NE.4)DRAK(2)=DRAK(2)+DAL
      GO TO 112
  114 IF(ITMOD.NE.8)ALFA(JST)=ALFA(JST)+DAL
      IF(ITMOD.NE.7)ALFA(JST+1)=ALFA(JST+1)-DAL
  112 HKSV=HKS
      MER =MER+1
      GOTO 35
  300 AK= .5*(COSG(PHISH-ALFA(JST+1))/SING(PHISH-ALFA(JST+1))
     1       -COSG(PHISH-ALFA(JST))/SING(PHISH-ALFA(JST)))
      AKP  =AK*180./9.8696044
      PHIM = 0.
      NU=1
      I= 1
      ANU =0.
      JH=0
      VI= 0.
  302 JH=JH+1
      FF1 = COSG(ABGR*FLA(JH))
      FF2 = DRAK(JH)/(1.+FF1)
      FG1 = COSG(ABGR*FLS(JH))
      FG3 = .6/(FG1-1.)
  304 VI= VI - CSLG(PHIM-90., ALFA(I))
      GO TO 310
  306 ARGN = ANU
      IF(ANU.GT..5* ABSZ)ARGN= ABSZ - ANU
      CSP = COSG(ARGN*ABGR)
      F=0.
      IF(ARGN.LT.FLA(JH))F=DRAM(JH)*ALOG((CSP-FF1)*FF2+1.)
      G=0.
      IF(ARGN.LT.FLS(JH))G=-HK(JH)*ALOG(1.-((CSP-FG1)*FG3)**2)
      P(NU)= F+G+CSLG(ANU*HABGR-90.,ALFA(I)) + VI
      P1(NU)=P(NU)-AK*ABS(SING((ANU*HABGR - 90.) - PHISH))
      NU = NU + 1
      ANU= ANU+ 1.
  310 IF(ANU-ANI(I))306,306,312
  312 IF(ANU- ABSZ)314,320,320
  314 PHIM = ANI(I)*HABGR
      VI=VI+CSLG(PHIM-90.,ALFA(I))
      I = I+1
      IF(I-1-JST)304,302,304
  320 PS=0.
      B2=0.
      DO 324 I=1,NKR
      PS=PS+P(I)
      BI = 2*(I-1)
  324 B2 = B2 + SING(BI*ABGR)*P(I)
      V1 = 2.*EXP(PS/ABSZ)
      SXI = .00000000
      SY=0.
      DO328 N=1,NQ
      Q=0.
      DO326 M=1,IB
      MN = N + 1 + MQ - 2*M
      MM = 2*N - MN
      IF(MN.GT.NKR) MN = MN - NKR
      IF(MM.LT.1) MM = MM + NKR
  326 Q = Q+ FKERN(M)*(P1(MN)-P1(MM))
      ANU= N-1
      ZP = ANU*HABGR - 90.
      ZL = COSG(ZP - PHISH)
      ZL = ABS((1.-ZL)/(1.+ZL))
      IF(ZL.NE.0.)ZL=ALOG(ZL)
      ARG(N) = Q - AKP*SING(ZP-PHISH)*ZL + ZP
      VF(N) = V1*EXP(-P(N))
      WV = COSG(ZP)/VF(N)
      XP(N)= WV*SING(ARG(N))
      YP(N)=-WV*COSG(ARG(N))
      SXI= SXI+ XP(N)
  328 SY = SY + YP(N)
      SX = SXI
      XPK = SX/(ABSZ  - 1.)
      YPK  = SY/(ABSZ -1.)
      DO 329 N=2,NKR
      XP(N)=XP(N)-XPK
  329 YP(N)=YP(N)-YPK
      CALL CINT(XP,X,NQ,IZZ)
      CALL CINT(YP,Y,NQ,IZZ)
      RQV = 0.
      DO 330 N=2,NKR
      RQ=X(N)*X(N)+Y(N)*Y(N)
      IF(RQ.GT.RQV)L=N
  330 RQV = RQ
      DO 327 I = 1,3
      IEPPL = L-2+I
  327 R(I)=SQRT(X(IEPPL)*X(IEPPL)+Y(IEPPL)*Y(IEPPL))
  333 TAU = (R(3)-R(1))/(4.*(R(2)+R(2)-R(1)-R(3)))
      XNAS = X(L)+TAU*(X(L+1)-X(L-1)+2.*TAU*(X(L+1)+X(L-1)-X(L)-X(L)))
      YNAS = Y(L)+TAU*(Y(L+1)-Y(L-1)+2.*TAU*(Y(L+1)+Y(L-1)-Y(L)-Y(L)))
      SQ = XNAS*XNAS + YNAS*YNAS
      AT=XNAS/SQ
      B= YNAS/SQ
      STREF = 1./SQRT(SQ)
      ETA =  ABSZ*STREF/PI
      CM = .5*ETA*STREF*B2
      DARG = 19.09859 *(3.*YNAS/XNAS - (YNAS/XNAS)**3)
      IF(ABS(SX)+ABS(SY).LT..0001*ABSZ) GO TO 335
      SX=STREF*SX*200.
      SY=STREF*SY*200.
      NZT=NZPZ(2,0)
      WRITE (IDRU,334) NZT,SX,SY
  334 FORMAT (A1,14HWARNING - SX =,F6.3,3X,4HSY =,F6.3)
  335 DO 331 N=2,NQ
      XR=X(N)
      X(N)= 1.-B*Y(N)-AT*XR
      Y(N)= B*XR -AT*Y(N)
      ARG(N) = ARG(N) - DARG
      WQ = (XP(N)+XP(N-1)-XPK-XPK)**2 + (YP(N)+YP(N-1)-YPK-YPK)**2
  331 DS(N-1) = STREF*SQRT(WQ)*(1.+.6666667*((XP(N)*YP(N-1)
     1-XP(N-1)*YP(N))/WQ)**2)
      NHKW=NQ/12
      DLT = Y(NHKW)/(BOGEN*(1.-X(NHKW)))
      NHKW=NQ-NHKW+1
      DLTU=-Y(NHKW)/(BOGEN*(1.-X(NHKW)))
      X(1) = 1.
      ARG(1)=ARG(1)-DARG
      IF(MAGAM.EQ.0) GO TO 346
      CALL DIA(X,Y,NKR,THK)
      THKP=100.*THK
      NZT=NZPZ(2,0)
      WRITE(IDRU,345)NZT,THKP,CM,DARG
  345 FORMAT(A1,9HTHICKNESS,F6.2,7H%, CM0=,F6.4,8H, ALFA0=,F6.3,5H DEG.)
  346 ITP=1
      ALN=DARG
      IF(PURES(13).GE.0.)GO TO 11
      PURES(12)=HKS/FCT1
      PURES(13)=.00001
   11 RETURN
      END
 
      SUBROUTINE CINT(P,Z,NQ,IZZ)
      DIMENSION P(NQ),Z(NQ)
      FCINT=0.
      IF(IZZ.NE.0) FCINT=.08333333333
      Z(1)=0.
      PVV=P(NQ-1)
      PV=P(1)
      PL=P(2)
      DO 10 N=2,NQ
      NZ=N+1-(NQ-1)*(N/NQ)
      PZ=P(NZ)
      Z(N)=Z(N-1)+PL+PV+(PL+PV-PZ-PVV)*FCINT
      PVV=PV
      PV=PL
   10 PL=PZ
      RETURN
      END
 
      SUBROUTINE QIP(X,Y,A)
      DIMENSION X(3),Y(3),A(3)
      C1 = (Y(2)-Y(1))/(X(2)-X(1))
      A(3)=(Y(3)-Y(1)-C1*(X(3)-X(1)))/((X(3)-X(1))*(X(2)-X(1)))
      A(1)=Y(1)-C1*X(1)+A(3)*X(1)*X(2)
      A(2)=C1-A(3)*(X(1)+X(2))
      RETURN
      END
 
      SUBROUTINE DIA(X,Y,NP,D)
      DIMENSION U(3),V(3),W(3),Z(3),A(3),B(3),X(121),Y(121)
      D = 0.
      XV=X(1)
      DO 4 N=2,NP
      NR = NP-1
      XS=X(N)
    1 IF(X(NR)-XS)3,2,2
    2 NR = NR - 1
      GO TO 1
    3 IF(NR-N.LE.3)GO TO 5
      YD=(Y(NR+1)-Y(NR))/(X(NR+1)-X(NR))
      DNN=(Y(N)-Y(NR)-(X(N)-X(NR))*YD)*(1.-.5*YD*YD)
      IF(DNN.LE.D)GO TO 4
      NM=N
      NRM=NR
      YF=YD
      D=DNN
    4 XV=XS
    5 IIT=0
      GO TO 8
    7 IIT=IIT+1
      IF(IIT.GT.20)GO TO 11
      DO 6 I=1,3
      NO=NM+2-I
      NU=NRM-2+I
      U(I)=TA*(X(NO)+YF*Y(NO))
      V(I)=TA*(Y(NO)-YF*X(NO))
      W(I)=TA*(X(NU)+YF*Y(NU))
    6 Z(I)=TA*(Y(NU)-YF*X(NU))
      CALL QIP(U,V,A)
      CALL QIP(W,Z,B)
      IF(ABS(A(3)-B(3)).LT..0001) GO TO 11
      XST = (B(2)-A(2))*.5/(A(3)-B(3))
      YS = A(2)+2.*A(3)*XST
      NMZ=NM
      NRMZ=NRM
      F=1.5
      IF(F*(U(3)-XST).LT.XST-U(2))NM=NM-1
      IF(F*(XST-U(1)).LT.U(2)-XST)NM=NM+1
      IF(F*(W(3)-XST).LT.XST-W(2))NRM=NRM+1
      IF(F*(XST-W(1)).LT.W(2)-XST)NRM=NRM-1
      IF(NMZ.NE.NM.OR.NRMZ.NE.NRM)GO TO 7
      IF(ABS(YS).LT..0001)GO TO 9
      YF=YF+YS/TA
    8 TA=1./SQRT(1.+YF*YF)
      GO TO 7
    9 D = A(1)-B(1)+(A(2)-B(2)+(A(3)-B(3))*XST)*XST
   11 RETURN
      END
 
      SUBROUTINE DIAGR(ISTIFT,ISTIM,MENV,NALA,NALE,X,Y,XP,NQ)
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      COMMON GAP(484),PUFF(22),GAPS(669),IGAP(6),GT(1116),P(121),P1(121)
      COMMON/SONIC/SON(2)
      COMMON/EA/IDUY(4),FCT1,FCT2,FCT3,FCT4,FCT5
      DIMENSION X(121),Y(121),XP(121)
      EXTERNAL TRUE,YG4,YG5
      LOGICAL PL,TRUE,YG4,YG5
      DATA RZE,ALMIN,ALMAX/200.,-5.,15./
      PL=ISTIFT.GE.5
      IF(ISTIM.GE.2)GO TO 10
      XMX=0.
      XAX=1.
      IF(MENV.EQ.1)GO TO 4
      IF(PUFF(1).NE.0.)RZE=FCT5*PUFF(1)
      HOCH=1.38*RZE
      QUER=1.55*RZE
      CALL DEFINE(PL,QUER,HOCH,-.15,1.4,-.08,1.3)
      GO TO 10
    4 ALMI=0.
      ALMA=0.
      IF(PUFF(1).NE.0.)ALMIN=PUFF(1)
      IF(PUFF(2).NE.0.)ALMAX=PUFF(2)
      HOCH=10.*(ALMAX-ALMIN)
      CALL DEFINE(PL,260.,HOCH,-.3,4.3,ALMIN,ALMAX)
   10 DO 348 M=NALA,NALE
      VMX=0.
      DO 349 N=1,NQ
      W=ABS(VPR(N,M))
      VQ=W*W
      IF(FMACH.NE.0.)CALL CPCOR(VQ,VQ)
      V=.5*W
      IF(ITIT1.EQ.2)V=.25*VQ+.25
      IF(VMX.LT.VQ)VMX=VQ
      IF(XMX.LT.V)XMX=V
  349 P(N)=V
      IF(MENV.NE.1)CALL POLZUG(ISTIFT,X,P,NQ,.TRUE.,YG4)
  348 P1(M)=VMX-1.
      IF(MENV.EQ.1)GO TO 20
      IF(FMACH.EQ.0.)GO TO 352
      VSON=SON(1)*.5
      IF(ITIT1.EQ.2)VSON=.5-.25*SON(2)
      IF(VSON.GT.1.25)GO TO 352
      IF(VSON.GT.XMX+.15)GO TO 352
      IF(XMX.LT.VSON)XMX=VSON
      VSP=VSON+.025
      CALL ACHS(1,VSON,VSP,VSP,.05,.65,.025,1.,TRUE)
  352 DO 350 I=1,NQ
      IF(X(I).GT.XAX)XAX=X(I)
  350 P(I)=Y(I)+.1
      CALL SMOOTH(ISTIFT,X,P,XP,NQ,TRUE)
      GO TO 30
   20 CALL POLZUG(ISTIFT,P1,ALV,NAL,.TRUE.,TRUE)
      ALMI=AMIN1(ALMI,ALV(1))
      ALMA=AMAX1(ALMA,ALV(NAL))
   30 IF(ISTIM.EQ.1.OR.ISTIM.GE.3)RETURN
      IF(MENV.EQ.1)GO TO 40
      XMX=AMIN1(XMX,1.25)
      CALL ACHS(2,0.,-.01,-.02,0.,XMX,.05,.25,YG5)
      CALL ACHS(1,0.,-.01,-.02,0.,XAX,.1,.5,TRUE)
      GO TO 50
   40 CALL ACHS(1,0.,-.2,-.5,0.,4.,.1,.5,TRUE)
      CALL ACHS(2,0.,-.04,-.1,ALMI,ALMA,1.,5.,TRUE)
   50 CALL GCLOSE
      RETURN
      END
 
      LOGICAL FUNCTION YG4(X,Y)
      A=X
      YG4=Y.GE..2.AND.Y.LE.1.25
      RETURN
      END
 
      LOGICAL FUNCTION YG5(X,Y)
      YG5=X.LT.-.0001.OR.ABS(Y-.1).GT..025
      RETURN
      END
 
      SUBROUTINE PUDECK
      CHARACTER*2 NAMP,NNESE,NUFF
      CHARACTER*4 ALTX,CPV
      COMMON/CHARS/NAMP(12),CPV(2),ALTX(4,2),NNESE,NUFF(80)
      COMMON GAP(420),P(92),X(121),Y(121),GAQ(243),ARG(121),GAR(57),
     * IG(2),NQ,IH(3),GAS(4),BOGEN,GAT(377),XP(121)
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      OPEN (ISTA,FILE='PUXY.DAT',STATUS='UNKNOWN')
      WRITE (ISTA,10) NAMP
  10  FORMAT('OUTPUT FROM SUBROUTINE PUDECK',/,12A1)
      XC=99.
      DO 20 I=1,NQ
      IF (X(I).LT.XC) THEN
         XC=X(I)
         IN=I
      END IF
  20  CONTINUE
      WRITE (ISTA,25) IN,NQ-IN+1
  25  FORMAT(2I5)
      WRITE (ISTA,30) (X(I),I=IN,1,-1)
      WRITE (ISTA,30) (Y(I),I=IN,1,-1)
      WRITE (ISTA,30) (X(I),I=IN,NQ)
      WRITE (ISTA,30) (Y(I),I=IN,NQ)
  30  FORMAT (8(F9.7,1X))
      RETURN
      END
 
      SUBROUTINE STRAAK(TE,RUA,YB,MXZ,ISTIFT,X,Y,BETA,NQ)
      DIMENSION X(NQ),Y(NQ),BETA(NQ)
      COMMON GAP(1175),IPAG(6),GAPT(1116),P(121),P1(121),XA(2),YA(2)
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
      EXTERNAL TRUE
      LOGICAL TRUE,PL
      DATA YV,YXA/10000.,10000./
      T = ABS(TE)
      PL=ISTIFT.GE.5
      YBL=ABS(YB)
      QUER=T+10.
      QRM=QUER-5.
      HOCH=YBL
      YMX = 0.
      YMN = 0.
      DO 2 I = 1,NQ
      IF(Y(I).GT.YMX) YMX = Y(I)
      IF(Y(I).LT.YMN) YMN = Y(I)
    2 CONTINUE
      IF(MGC)3,6,3
    3 IF(TE)5,16,8
    5 CALL GCLOSE
      IF(T-1.)16,6,6
    6 CALL DEFINE(PL,QUER,HOCH,-5.,QRM,0.,HOCH)
      YXA = 5.-T*YMN
      MSTR=0
      GO TO 10
    8 YXA = YXA + RUA
      IF(YB.GT.0.)YXA=YV-T*YMN+RUA
   10 YV = YXA + T*YMX
      IF(YV.GE.YBL.AND.MSTR.NE.0)GO TO 5
      MSTR=1
      DO 12 I=1,NQ
      P1(I) = T*X(I)
   12 P(I) = T*Y(I)+YXA
      CALL SMOOTH(ISTIFT,P1,P,BETA,NQ,TRUE)
      IF(MXZ)16,16,14
   14 XA(1) = T
      XA(2) = 0.
      YA(1) = YXA
      YA(2) = YXA
      CALL POLZUG(ISTIFT,XA,YA,2,.TRUE.,TRUE)
   16 RETURN
      END
 
      SUBROUTINE STRDR(T,NT)
      CHARACTER*2 NZPZ,NZT,NNESE,NUFF,NAMP
      CHARACTER*4 ALTX,CPV
      DIMENSION XDR(8), YDR(8),T(42)
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      COMMON/CHARS/NAMP(12),CPV(2),ALTX(4,2),NNESE,NUFF(80)
      COMMON P1(121),P(121),XP(121),YP(121),PUFF(22),AGAM(6),X(121),
     1Y(121),DS(122),VF(121),ARG(121),ANI(28),ALFA(29),IZZ,KFU,NQ,NUPRO,
     2JAB,JST,CM,ETA,ABFA,PI,BOGEN,DARG
      EQUIVALENCE (XDR(1),YP(106)),(YDR(1),YP(114))
      DO 8 N = 1,NT,8
      I = 0
      NZL = N+7
      IF(NZL.GT.NT)NZL=NT
      NZT=NZPZ(3,0)
    1 WRITE(IDRU,2)NZT,NUPRO,DARG,CM
    2 FORMAT (A1,8HAIRFOIL ,I4,3X,8HALPHA0 =,F5.2,8H DEGREES,3X,
     *5HCM0 =,F7.4)
      NZT=NZPZ(1,0)
      WRITE(IDRU,4)NZT,(M,M=N,NZL)
    4 FORMAT (A1,7(I2,17H  X(CM)   Y(CM)  ))
    5 NZT=NZPZ(1,0)
      IF(NZT.EQ.NNESE)GO TO 1
      I=I+1
      DO 6 K = N,NZL
      L = K-N+1
      XDR(L) = X(I)*.1*ABS(T(K))
    6 YDR(L) = Y(I)*.1*ABS(T(K))
      WRITE(IDRU,10) NZT,(XDR(M),YDR(M),M=1,L)
   10 FORMAT (A1,7(F9.2,F8.2,2X))
      IF(I.LT.NQ)  GOTO 5
    8 CONTINUE
      RETURN
      END
 
      BLOCK DATA
      CHARACTER ALTX*4,CPV*4,NNESE*2,NAMP*2,NUFF*2
      COMMON /GRZK/CDK,AA(7),BB(7)
      COMMON/PRAL/DLT,DLTU,ALN,ALV(14),NAL,ITP,CML(14),CRL(14),
     1DARF,ITIT1,ITIT2,D1I(121,5),AVI(5,5),BVI(5,5),
     2 FMACH,BEMACH,IVI,NAIT(5),XDA,YDA,DEFLG,MOMAG,NAI
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      COMMON/CHARS/NAMP(12),CPV(2),ALTX(4,2),NNESE,NUFF(80)
      COMMON/TRIT/DLV,SUMP,XTRI(4),NU,ND,XSTPI(4),STHI(4)
      COMMON /LINING/BROKL(12),NLINE(5),NPAR(5),J
      DATA ILES,IDRU,ISTA,NNESE/2,3,4,'1'/
      DATA XTRI/4*0./,CPV/'   V','  CP'/,ALTX/' ZER','O-LI','FT L',
     *'INE ',' CHO','RD L','INE ','    '/,MGC,CDK/0,.01/,NAL/0/
      DATA NLINE/2*1,3*3/,NPAR/0,2,4,6,8/,BROKL/5.,1.5,10.,9*1.5/
      DATA FMACH,BEMACH/0.,1./
      END
 
      SUBROUTINE DLFF(L,PF,ND,NW)
      CHARACTER*2 MZ,NUFF(80),NNESE,NAMP(12)
      CHARACTER*4 ALTX,CPV
      COMMON/CHARS/NAMP,CPV(2),ALTX(4,2),NNESE,NUFF
      COMMON/EA/ILES,IDRU,ISTA,MARD,FCT1,FCT2
     *,FCT3,FCT4,FCT5
      DIMENSION MZ(16),PF(20)
      DATA MZ/'0','1','2','3','4','5','6','7','8','9','.',',','+',
     1'-','F',' '/
      IF(L.NE.0)LM=L
      NW=0
   24 MBL=1
      ZAHL=0.
      ZCH=1.
      NPK=0
      NEX=0
    1 IF(LM-81)2,16,16
    2 DO 3 N=1,16
      IF(NUFF(LM).EQ.MZ(N)) GO TO 4
    3 CONTINUE
      WRITE(IDRU,20)(NUFF(I),I=1,80)
   20 FORMAT(17H FEHLER IN KARTE   , 80A1)
      GO TO 22
    4 LM=LM+1
      IF(N-11)12,14,5
    5 IF(N-13)16,1,6
    6 IF(N-15)10,13,16
   10 ZCH=-1.
      GO TO 1
   12 ZAHL=10.*ZAHL+FLOAT(N-1)
      NEX=NEX-NPK
      MBL=0
      GO TO 1
   13 READ(ILES,15)(NUFF(I),I=1,80)
   15 FORMAT(80A1)
      LM=1
      GO TO 2
   14 NPK=1
      GO TO 1
   16 C=ZCH*ZAHL*10.**NEX
   18 IF(MBL.EQ.1)GO TO 23
      NP=NW+ND
      NW=NW+1
      PF(NP)=C
      GO TO 24
   22 NW=-NW
   23 RETURN
      END
CJR
	SUBROUTINE PLOT(X,Y,I)
	IF (I.EQ.-3) GO TO 30
	WRITE (7,10) X,Y,I
10      FORMAT (1X,F10.6,',',F10.6,',',I2)
30      RETURN
	END
 
      SUBROUTINE DEFINE(PL,Q,H,XU,XO,YU,YO)
      CHARACTER*12 CH
      LOGICAL PL,PLOPEN
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
      COMMON/GRMIN/XMIN,YMIN,XSCALE,YSCALE
      COMMON/PLOTZ/IPLOT
      DATA PLOPEN/.FALSE./
      IF (.NOT.PLOPEN) THEN
	 WRITE (*,10)
	 READ (*,5) CH
	 OPEN (UNIT=7,FILE=CH,STATUS='UNKNOWN')
	 PLOPEN=.TRUE.
      END IF
      MPL=1
      XMIN=XU
      YMIN=YU
      IF (MGC.NE.0) CALL GCLOSE
      MGC=1
      XZEH=Q/(XO-XU)
      YZEH=H/(YO-YU)
      XSCALE=XZEH/25.4
      YSCALE=YZEH/25.4
   10 FORMAT (/,' ENTER NAME FOR PLOT FILE: ')
    5 FORMAT(A12)
      IF (IPLOT.EQ.1) WRITE (7,*) 'DIAG PLOT'
      IF (IPLOT.EQ.2) WRITE (7,*) 'CDCL PLOT'
      IF (IPLOT.EQ.3) WRITE (7,*) 'STRK PLOT'
      IF (IPLOT.EQ.4) WRITE (7,*) 'DPIT PLOT'
      IF (IPLOT.EQ.5) WRITE (7,*) 'BLAYER PLOT'
      RETURN
      END

      SUBROUTINE GCLOSE
      COMMON/PLTM/MPL,MGC,XZEH,YZEH,MSPLI
C  TERMINATES CURRENT PLOT
      CALL PLOT(1.,0.,-3)
C     CLOSE (7)
      WRITE (7,*) '999,999,999'
      MGC=0
      RETURN
      END

      SUBROUTINE FINISH
C  TERMINATES ALL PLOTTING
      RETURN
      END

      SUBROUTINE TPLOT(X,Y,NPEN,NORIG)
      COMMON/GRMIN/XMIN,YMIN,XSCALE,YSCALE
      A=(X-XMIN)*XSCALE
      B=(Y-YMIN)*YSCALE
C  MOVE PEN TO (A,B) WITH PEN DOWN (NPEN=1) OR UP (NPEN=0)
      IPEN=3-NPEN
      CALL PLOT(A,B,IPEN)
      RETURN
      END
      SUBROUTINE FTLUP(X,Y,M,N,VARI,VARD)
      INTEGER ULIMIT
      DIMENSION VARI(N),VARD(N),DELTAY(2),YPRIME(2)
      COMMON/DIF/YPRIME,LLIMIT
      LLIMIT=0
      ULIMIT=N
10    IF (ULIMIT-LLIMIT.EQ.1) GO TO 50
      INDEX=(ULIMIT-LLIMIT)/2.+.5+LLIMIT
      IF (X-VARI(INDEX)) 20,30,40
20    ULIMIT=INDEX
      GO TO 10
30    Y=VARD(INDEX)
      RETURN
40    LLIMIT=INDEX
      GO TO 10
50    IF (ULIMIT.LT.2) ULIMIT=2
      LLIMIT=ULIMIT-1
      SLOPE=(VARD(ULIMIT)-VARD(LLIMIT))/(VARI(ULIMIT)-VARI(LLIMIT))
      YZERO=VARD(LLIMIT)+SLOPE*(X-VARI(LLIMIT))
      CALL DERIV(VARI,VARD,N)
      DO 60 K=1,2
      K2=LLIMIT+K-1
60    DELTAY(K)=VARD(K2)+YPRIME(K)*(X-VARI(K2))-YZERO
      TEST=DELTAY(1)*DELTAY(2)
      IF (TEST) 70,80,90
70    Y=YZERO+(TEST*(X-VARI(LLIMIT)+X-VARI(ULIMIT)))/((DELTAY(1)-
     @DELTAY(2))*(VARI(ULIMIT)-VARI(LLIMIT)))
      RETURN
80    Y=YZERO
      RETURN
90    Y=YZERO+TEST/(DELTAY(1)+DELTAY(2))
      RETURN
      END
      SUBROUTINE DERIV(X,Y,NP)
      INTEGER FIRST
      DOUBLE PRECISION A2,A3
      LOGICAL DONE,ENDP
      DIMENSION X(NP),Y(NP),SLOPE(2)
      COMMON/DIF/SLOPE,ISTART
      INDEX=ISTART
      DONE=.FALSE.
      ENDP=.FALSE.
      K2=1
      FIRST=INDEX-1
      IF (FIRST.LT.1) THEN
         FIRST=1
         ENDP=.TRUE.
      END IF
      IF (FIRST+2.GT.NP) THEN
         FIRST=NP-2
         ENDP=.TRUE.
      END IF
10    XP1=X(FIRST)-X(FIRST+1)
      XP2=X(FIRST+2)-X(FIRST+1)
      YP1=Y(FIRST)-Y(FIRST+1)
      YP2=Y(FIRST+2)-Y(FIRST+1)
      A2=(YP1*XP2/XP1-YP2*XP1/XP2)/(XP2-XP1)
      A3=(YP1/XP1-YP2/XP2)/(XP1-XP2)
      A2=A2-2.*A3*X(FIRST+1)
      SLOPE(K2)=A2+2.*A3*X(INDEX)
      IF (DONE) RETURN
      K2=2
      INDEX=INDEX+1
      DONE=.TRUE.
      IF (.NOT.ENDP) FIRST=FIRST+1
      GO TO 10
      END
	SUBROUTINE NEWPEN(I)
	character*5 color
	character*1 ch
	goto (20,30,40,50),i
20	color='black'
	goto 60
30	color=' red'
	go to 60
40	color='blue'
	go to 60
50	color='green'
60	write (*,70) color
70	format(//,' Place ',a,' pen in Sweet-P before continuing.')
	return
	end

      SUBROUTINE FINIT
      CHARACTER*12 FNAME
      COMMON/EA/ILES,IDRU,ISTA,MARD,DUM(5)
  10  WRITE (*,*) 'ENTER INPUT FILE NAME: '
      READ (*,5) FNAME
   5  FORMAT(A12)
      OPEN (ILES,FILE=FNAME,STATUS='OLD',ERR=100)
      WRITE (*,*) 'ENTER OUTPUT FILE NAME: '
      READ (*,5) FNAME
      OPEN (IDRU,FILE=FNAME,STATUS='UNKNOWN')
      RETURN
100   WRITE(*,110) FNAME
110   FORMAT(/,' ***ERROR IN OPENING FILE ',A,/,' TRY AGAIN.',/)
      GO TO 10
      END
